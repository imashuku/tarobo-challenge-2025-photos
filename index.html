<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tarobo Faces - Random 30 Slideshow</title>
  <style>
    :root { --fade-ms: 1200; --show-ms: 2500; }
    html,body,#stage{height:100%;margin:0;background:#000}
    #stage{position:relative;overflow:hidden;touch-action:none}
    .slide{
      position:absolute; inset:0;
      width:100%; height:100%; object-fit:cover;
      opacity:0;
      transition:opacity 1200ms ease-in-out;
      will-change: opacity;
    }
    .slide.active{opacity:1}
    #hud{
      position:fixed; left:12px; bottom:12px; z-index:25;
      color:#fff; font:12px/1.4 system-ui,-apple-system,Segoe UI,Roboto;
      background:rgba(0,0,0,.35); padding:8px 10px; border-radius:10px;
      backdrop-filter: blur(6px);
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      max-width:calc(100vw - 200px);
      transition: bottom 0.3s ease, opacity 0.3s ease, transform 0.3s ease;
      opacity: 1;
      transform: translateY(0);
    }
    #hud.hidden{
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
    }
    #hud.raised{
      bottom:152px; /* ã‚µãƒ ãƒã‚¤ãƒ«é«˜ã•140px + ä½™ç™½12px */
    }
    button{border:1px solid #666; background:#111; color:#fff; padding:6px 10px; border-radius:8px; cursor:pointer; margin:0}
    button:hover{background:#333; border-color:#888}
    button:active{background:#000}
    button.active{background:#0066cc; border-color:#0066cc}
    a{color:#8bdcff}

    /* ç”»åƒæƒ…å ±è¡¨ç¤º */
    #image-info{
      position:fixed; top:12px; right:12px; z-index:10;
      color:#fff; font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto;
      background:rgba(0,0,0,.35); padding:10px 14px; border-radius:10px;
      backdrop-filter: blur(6px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      opacity: 1;
      transform: translateY(0);
    }
    #image-info.hidden{
      opacity: 0;
      transform: translateY(-20px);
      pointer-events: none;
    }
    #counter{font-size:20px; font-weight:bold; margin-bottom:4px}
    #filename{font-size:12px; opacity:0.8; max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}

    /* é€²æ—ãƒãƒ¼ */
    #progress-bar{
      position:fixed; top:0; left:0; right:0; height:3px; z-index:20;
      background:rgba(255,255,255,0.1);
    }
    #progress-fill{
      height:100%; width:0%; background:linear-gradient(90deg, #0066cc, #00ccff);
      transition:width 100ms linear;
    }

    /* ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¯å‰Šé™¤æ¸ˆã¿ */

    /* Aboutãƒœã‚¿ãƒ³ */
    #about-btn{
      position:fixed; top:12px; left:12px; z-index:10;
      width:60px; height:60px; border-radius:10px;
      background:rgba(0,0,0,0.35); border:1px solid #666;
      color:#fff; font-size:24px; cursor:pointer;
      backdrop-filter: blur(6px);
      transition: all 0.3s ease, opacity 0.3s ease, transform 0.3s ease;
      display:flex; align-items:center; justify-content:center;
      opacity: 1;
    }
    #about-btn.hidden{
      opacity: 0;
      transform: translateY(-20px);
      pointer-events: none;
    }
    #about-btn:hover{
      transform:scale(1.05);
      background:rgba(0,0,0,0.5);
      border-color:#888;
    }
    #about-panel{
      position:fixed; top:60px; left:60px; z-index:10;
      color:#fff; font:12px/1.6 system-ui,-apple-system,Segoe UI,Roboto;
      background:rgba(0,0,0,0.85); padding:12px 16px; border-radius:10px;
      backdrop-filter: blur(10px);
      border:1px solid #666;
      max-width:360px;
      display:none;
    }
    #about-panel.show{ display:block; }
    #about-panel h3{
      margin:0 0 12px 0; font-size:14px; font-weight:bold;
    }
    #about-panel p{
      margin:8px 0;
      line-height:1.6;
    }
    #about-panel .tagline{
      font-size:11px;
      color:#999;
      margin-top:12px;
      padding-top:8px;
      border-top:1px solid #444;
    }


    /* ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ç”»é¢ */
    #opening{
      position:fixed; inset:0; z-index:200;
      background:#000;
      display:flex; align-items:center; justify-content:center;
      opacity:1;
      transition:opacity 0.8s ease;
    }
    #opening.hide{ opacity:0; pointer-events:none; }
    #opening-content{
      text-align:center; color:#fff;
      max-width:600px; padding:40px;
    }
    #opening-logo{
      width:120px; height:auto;
      margin:0 auto 24px auto;
      display:block;
      opacity:0.9;
    }
    #opening h1{
      font-size:28px; font-weight:bold; margin:0 auto 16px auto;
      line-height:1.6;
      text-align:center;
      width:100%;
    }
    #opening .sub{
      font-size:16px; color:#999; margin:0 0 32px 0;
    }
    #opening .tagline{
      font-size:14px; margin:32px 0;
      padding:16px 0; border-top:1px solid #333; border-bottom:1px solid #333;
    }
    #opening-start{
      background:rgba(255,255,255,0.1); border:1px solid #666;
      color:#fff; padding:12px 32px; border-radius:8px;
      font-size:16px; cursor:pointer;
      transition:all 0.3s;
      margin-top:24px;
    }
    #opening-start:hover{
      background:rgba(255,255,255,0.2); border-color:#888;
      transform:scale(1.05);
    }
    #opening-skip{
      background:transparent; border:none;
      color:#666; padding:8px; margin-top:16px;
      font-size:12px; cursor:pointer;
    }
    #opening-skip:hover{ color:#999; }

    /* ã„ã„ã­ãƒœã‚¿ãƒ³ */
    #like-btn{
      position:fixed; right:12px; bottom:80px; z-index:15;
      width:60px; height:60px; border-radius:10px;
      background:rgba(0,0,0,0.35); border:1px solid #666;
      color:#fff; font-size:28px; cursor:pointer;
      backdrop-filter: blur(6px);
      transition: all 0.3s ease, opacity 0.3s ease, transform 0.3s ease, bottom 0.3s ease;
      opacity: 1;
    }
    #like-btn.raised{
      bottom:220px; /* ã‚µãƒ ãƒã‚¤ãƒ«é«˜ã•140px + HUDä½™ç™½12px + å…ƒã®bottom 80px - 12pxèª¿æ•´ */
    }
    #like-btn.hidden{
      opacity: 0;
      transform: translateX(20px);
      pointer-events: none;
    }
    #like-btn:hover{
      transform:scale(1.05);
      background:rgba(0,0,0,0.5);
      border-color:#888;
    }
    #like-btn:active{ transform:scale(0.95); }
    #like-btn.liked{ animation: heartBeat 0.6s ease; }
    @keyframes heartBeat {
      0% { transform: scale(1); }
      15% { transform: scale(1.3); }
      30% { transform: scale(1.1); }
      45% { transform: scale(1.25); }
      60% { transform: scale(1.1); }
      75% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }
    #like-count{
      position:absolute; top:-8px; right:-8px;
      background:rgba(255,50,50,0.95); color:#fff; font-size:13px; font-weight:bold;
      padding:3px 7px; border-radius:12px; min-width:22px; text-align:center;
      border:2px solid rgba(255,255,255,0.4);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    }

    /* SNSã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ */
    #share-btns{
      position:fixed; right:12px; bottom:150px; z-index:15;
      display:flex; flex-direction:column; gap:6px;
      transition: opacity 0.3s ease, transform 0.3s ease, bottom 0.3s ease;
      opacity: 1;
    }
    #share-btns.raised{
      bottom:290px; /* ã‚µãƒ ãƒã‚¤ãƒ«é«˜ã•140px + å…ƒã®bottom 150px */
    }
    #share-btns.hidden{
      opacity: 0;
      transform: translateX(20px);
      pointer-events: none;
    }
    .share-btn{
      width:60px; height:60px; border-radius:10px;
      border:1px solid #666; cursor:pointer; font-size:20px;
      transition: all 0.3s ease;
      background:rgba(0,0,0,0.35);
      color:#fff;
      backdrop-filter: blur(6px);
      display:flex; align-items:center; justify-content:center;
    }
    .share-btn:hover{
      transform:scale(1.05);
      background:rgba(0,0,0,0.5);
      border-color:#888;
    }
    .share-btn:active{ transform:scale(0.95); }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç”»åƒæ‹¡å¤§è¡¨ç¤ºï¼‰ */
    #modal{
      display:none; position:fixed; inset:0; z-index:100;
      background:rgba(0,0,0,0.95); cursor:zoom-out;
      align-items:center; justify-content:center;
    }
    #modal.show{ display:flex; }
    #modal img{
      max-width:90%; max-height:90%; object-fit:contain;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    #modal-close{
      position:absolute; top:20px; right:20px;
      background:rgba(255,255,255,0.2); border:none;
      color:#fff; font-size:30px; width:50px; height:50px;
      border-radius:50%; cursor:pointer;
      backdrop-filter: blur(6px);
    }
    #modal-close:hover{ background:rgba(255,255,255,0.3); }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã„ã„ã­ãƒœã‚¿ãƒ³ */
    #modal-like-btn{
      position:absolute; bottom:20px; right:20px;
      width:60px; height:60px; border-radius:10px;
      background:rgba(0,0,0,0.5); border:1px solid #666;
      color:#fff; font-size:30px; cursor:pointer;
      backdrop-filter: blur(6px);
      transition: all 0.3s ease;
      display:flex; align-items:center; justify-content:center;
    }
    #modal-like-btn:hover{
      transform:scale(1.05);
      background:rgba(0,0,0,0.7);
      border-color:#888;
    }
    #modal-like-btn.liked{
      animation: heartBeat 0.6s ease;
    }

    /* ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé¸æŠ */
    /* ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã¯å‰Šé™¤æ¸ˆã¿ */

    /* BGMã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
    #bgm-controls{
      display:flex; gap:6px; align-items:center;
    }
    #bgm-toggle{
      background:#111; border:1px solid #666;
      color:#fff; padding:6px 10px; border-radius:8px; cursor:pointer;
      white-space:nowrap;
    }
    #bgm-toggle.playing{ background:#0066cc; border-color:#0066cc; }
    #bgm-volume{
      width:60px;
    }

    /* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨ */
    .slide.effect-slide-left{
      transform:translateX(-100%);
      transition:opacity var(--fade-ms)ms linear, transform var(--fade-ms)ms ease-out;
    }
    .slide.effect-slide-left.active{ transform:translateX(0); }

    .slide.effect-slide-right{
      transform:translateX(100%);
      transition:opacity var(--fade-ms)ms linear, transform var(--fade-ms)ms ease-out;
    }
    .slide.effect-slide-right.active{ transform:translateX(0); }

    .slide.effect-zoom{
      transform:scale(0.8);
      transition:opacity var(--fade-ms)ms linear, transform var(--fade-ms)ms ease-out;
    }
    .slide.effect-zoom.active{ transform:scale(1); }

    .slide.effect-rotate{
      transform:rotate(-5deg) scale(0.9);
      transition:opacity var(--fade-ms)ms linear, transform var(--fade-ms)ms ease-out;
    }
    .slide.effect-rotate.active{ transform:rotate(0deg) scale(1); }

    /* ã‚µãƒ ãƒã‚¤ãƒ«ä¸€è¦§ */
    #thumbnails-container{
      position:fixed; bottom:0; left:0; right:0; height:0; z-index:20;
      background:rgba(0,0,0,0.9); backdrop-filter:blur(10px);
      transition:height 0.3s ease;
      overflow:hidden;
    }
    #thumbnails-container.show{ height:140px; }
    #thumbnails-wrapper{
      display:flex; gap:8px; padding:12px;
      overflow-x:auto; overflow-y:hidden; height:100%;
      align-items:center;
    }
    #thumbnails-wrapper::-webkit-scrollbar{ height:8px; }
    #thumbnails-wrapper::-webkit-scrollbar-track{ background:rgba(255,255,255,0.1); }
    #thumbnails-wrapper::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,0.3); border-radius:4px;
    }
    .thumbnail{
      flex-shrink:0; width:100px; height:100px;
      object-fit:cover; border-radius:8px; cursor:pointer;
      border:2px solid transparent; transition:all 0.2s ease;
      position:relative;
    }
    .thumbnail:hover{
      transform:scale(1.1); border-color:#888;
    }
    .thumbnail.active{
      border-color:#0066cc; box-shadow:0 0 12px rgba(0,102,204,0.6);
    }
    .thumbnail.liked::after{
      content:'ğŸ¤'; position:absolute; top:4px; right:4px;
      font-size:16px; text-shadow:0 0 4px rgba(0,0,0,0.8);
    }

    /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ */
    #filter-controls{
      position:fixed; top:50%; right:12px; transform:translateY(-50%); z-index:15;
      display:flex; flex-direction:column; gap:6px;
      transition: opacity 0.3s ease, transform 0.3s ease;
      opacity: 1;
    }
    #filter-controls.hidden{
      opacity: 0;
      transform: translateY(-50%) translateX(20px);
      pointer-events: none;
    }
    #filter-all, #filter-liked{
      width:60px; height:60px; border-radius:10px;
      border:1px solid #666; cursor:pointer;
      background:rgba(0,0,0,0.35); color:#fff;
      backdrop-filter:blur(6px); transition:all 0.3s ease;
      display:flex; align-items:center; justify-content:center;
      font-size:24px;
    }
    #filter-all:hover, #filter-liked:hover{
      transform:scale(1.05); background:rgba(0,0,0,0.5); border-color:#888;
    }
    #filter-all.active, #filter-liked.active{
      background:#0066cc; border-color:#0066cc;
    }

    /* çµ±è¨ˆæƒ…å ±ãƒ‘ãƒãƒ« */
    #stats-btn{
      position:fixed; top:12px; left:80px; z-index:10;
      width:60px; height:60px; border-radius:10px;
      background:rgba(0,0,0,0.35); border:1px solid #666;
      color:#fff; font-size:24px; cursor:pointer;
      backdrop-filter: blur(6px);
      transition: all 0.3s ease, opacity 0.3s ease, transform 0.3s ease;
      display:flex; align-items:center; justify-content:center;
      opacity: 1;
    }
    #stats-btn.hidden{
      opacity: 0;
      transform: translateY(-20px);
      pointer-events: none;
    }
    #stats-btn:hover{
      transform:scale(1.05);
      background:rgba(0,0,0,0.5);
      border-color:#888;
    }
    #stats-panel{
      position:fixed; top:60px; left:128px; z-index:10;
      color:#fff; font:12px/1.6 system-ui,-apple-system,Segoe UI,Roboto;
      background:rgba(0,0,0,0.85); padding:12px 16px; border-radius:10px;
      backdrop-filter: blur(10px);
      border:1px solid #666;
      max-width:320px;
      display:none;
      min-width:280px;
    }
    #stats-panel.show{ display:block; }
    #stats-panel h3{
      margin:0 0 12px 0; font-size:14px; font-weight:bold;
    }
    #stats-panel .stat-item{
      display:flex; justify-content:space-between; align-items:center;
      margin:8px 0; padding:10px 12px;
      background:rgba(255,255,255,0.05);
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.1);
    }
    #stats-panel .stat-label{
      color:#aaa; font-size:12px; font-weight:500;
    }
    #stats-panel .stat-value{
      color:#00ccff; font-size:24px; font-weight:bold;
    }
    #stats-panel .ranking-list{
      margin:12px 0 0 0; padding:0; list-style:none;
      max-height:300px; overflow-y:auto;
    }
    #stats-panel .ranking-item{
      display:flex; align-items:center; gap:8px;
      margin:6px 0; padding:8px 10px; background:rgba(255,255,255,0.05);
      border-radius:6px; cursor:pointer;
      transition:all 0.2s;
      border:1px solid rgba(255,255,255,0.1);
    }
    #stats-panel .ranking-item:hover{
      background:rgba(0,102,204,0.2); transform:translateX(4px);
      border-color:rgba(0,102,204,0.5);
    }
    #stats-panel .ranking-item:active{
      transform:translateX(2px) scale(0.98);
    }
    #stats-panel .ranking-rank{
      font-size:16px; font-weight:bold; color:#0066cc; min-width:24px;
    }
    #stats-panel .ranking-count{
      margin-left:auto; color:#ff6b6b; font-weight:bold;
    }
    #stats-panel .loading{
      text-align:center; padding:20px; color:#666;
    }

    /* ã„ã„ã­ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå¼·åŒ– */
    @keyframes heartPop {
      0% { transform: scale(1); }
      20% { transform: scale(1.4) rotate(-5deg); }
      40% { transform: scale(1.2) rotate(5deg); }
      60% { transform: scale(1.3) rotate(-3deg); }
      80% { transform: scale(1.15) rotate(2deg); }
      100% { transform: scale(1) rotate(0deg); }
    }
    @keyframes heartFloat {
      0% { opacity: 1; transform: translateY(0) scale(0.5); }
      50% { opacity: 0.8; transform: translateY(-30px) scale(1); }
      100% { opacity: 0; transform: translateY(-60px) scale(0.8); }
    }
    @keyframes ripple {
      0% { transform: scale(0.8); opacity: 1; }
      100% { transform: scale(2.5); opacity: 0; }
    }
    .heart-effect{
      position:fixed; font-size:40px; pointer-events:none;
      animation: heartFloat 1s ease-out forwards;
      z-index:1000;
    }
    .ripple-effect{
      position:absolute; inset:0; border-radius:10px;
      border:3px solid rgba(255,50,50,0.6);
      animation: ripple 0.6s ease-out;
      pointer-events:none;
    }

    /* Instagramé¢¨ã„ã„ã­é€šçŸ¥ */
    #like-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 200;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    #like-notification.show {
      opacity: 1;
    }
    #like-notification-content {
      font-size: 64px;
      text-align: center;
      animation: likePopup 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      filter: drop-shadow(0 4px 20px rgba(0,0,0,0.4));
    }
    #like-notification-content.unlike {
      font-size: 48px;
      opacity: 0.7;
    }
    @keyframes likePopup {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* ã‚µãƒ ãƒã‚¤ãƒ«ä¸Šã®ã„ã„ã­è§£é™¤ãƒœã‚¿ãƒ³ */
    .thumbnail-container {
      position: relative;
      display: inline-block;
    }
    .thumbnail-like-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 36px;
      height: 36px;
      background: rgba(0,0,0,0.75);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s ease;
      z-index: 10;
      backdrop-filter: blur(4px);
    }
    .thumbnail-like-btn:hover {
      transform: scale(1.15);
      background: rgba(255,50,50,0.9);
      border-color: rgba(255,255,255,0.6);
    }
    .thumbnail-like-btn:active {
      transform: scale(0.95);
    }

    /* ã„ã„ã­ãƒœã‚¿ãƒ³ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆPCç”¨ï¼‰ */
    #like-btn::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }
    #like-btn:hover::after {
      opacity: 1;
    }
    @media (max-width: 768px) {
      #like-btn::after {
        display: none; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—éè¡¨ç¤º */
      }
    }

    /* ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ */
    #realtime-notify{
      position:fixed; top:80px; right:12px; z-index:100;
      background:rgba(255,50,50,0.95); color:#fff;
      padding:12px 16px; border-radius:8px;
      font:12px/1.4 system-ui,-apple-system,Segoe UI,Roboto;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
      transform:translateX(400px);
      transition:transform 0.3s ease;
      max-width:280px;
    }
    #realtime-notify.show{
      transform:translateX(0);
    }
    #realtime-notify .notify-icon{
      display:inline-block; margin-right:8px; font-size:16px;
    }

    /* ã‚¹ãƒãƒ›å¯¾å¿œ */
    @media (max-width: 768px) {
      /* HUDï¼ˆãƒœã‚¿ãƒ³ç¾¤ï¼‰ã‚’å°ã•ã */
      #hud{
        font-size:10px;
        padding:6px 8px;
        gap:4px;
        max-width:calc(100vw - 24px);
        left:6px;
        bottom:6px;
      }
      #hud.raised{
        bottom:126px; /* ã‚µãƒ ãƒã‚¤ãƒ«é«˜ã•ã‚’èª¿æ•´ */
      }

      /* ãƒœã‚¿ãƒ³ã‚’å°ã•ã */
      button{
        padding:4px 8px;
        font-size:11px;
        border-radius:6px;
      }
      /* ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¯å‰Šé™¤æ¸ˆã¿ */

      /* ç”»åƒæƒ…å ±ã‚’å°ã•ã */
      #image-info{
        top:6px;
        right:6px;
        padding:6px 10px;
        font-size:12px;
      }
      #counter{
        font-size:16px;
      }
      #filename{
        font-size:10px;
        max-width:150px;
      }

      /* Aboutãƒœã‚¿ãƒ³ */
      #about-btn{
        top:6px;
        left:6px;
        width:50px;
        height:50px;
        font-size:20px;
      }

      /* çµ±è¨ˆãƒœã‚¿ãƒ³ */
      #stats-btn{
        top:6px;
        left:62px;
        width:50px;
        height:50px;
        font-size:20px;
      }

      /* çµ±è¨ˆãƒ‘ãƒãƒ« */
      #stats-panel{
        top:62px;
        left:6px;
        right:6px;
        max-width:none;
        min-width:0;
        width:calc(100vw - 12px);
        max-height:calc(100vh - 80px);
        overflow-y:auto;
        font-size:11px;
        padding:10px 12px;
      }

      /* ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºã‚’å°ã•ã */
      #thumbnail-container{
        height:100px;
      }
      #thumbnail-list{
        height:100px;
      }
      .thumbnail{
        width:70px;
        height:70px;
      }

      /* å³å´ãƒœã‚¿ãƒ³ç¾¤ã®é…ç½®ã‚’å†è¨ˆç®— */
      /* HUDã¯2è¡Œã«æŠ˜ã‚Šè¿”ã™å¯èƒ½æ€§ãŒã‚ã‚Šã€é«˜ã•ç´„80-100px */

      /* ã„ã„ã­ãƒœã‚¿ãƒ³ï¼ˆä¸€ç•ªä¸‹ï¼‰ */
      #like-btn{
        width:50px;
        height:50px;
        font-size:24px;
        bottom:110px; /* HUDåˆ†ã®ä½™è£•ã‚’æŒãŸã›ã‚‹ */
        right:6px;
      }
      #like-btn.raised{
        bottom:250px; /* ã‚µãƒ ãƒã‚¤ãƒ«é«˜ã•140px + HUDä½™ç™½12px + å…ƒã®bottom 110px - 12pxèª¿æ•´ */
      }

      /* SNSã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ï¼ˆã„ã„ã­ã®ä¸Šã€3ã¤ç¸¦ã«ä¸¦ã¶: 50pxÃ—3 + gap 6pxÃ—2 = 162pxï¼‰ */
      #share-btns{
        bottom:166px; /* 110px(ã„ã„ã­bottom) + 50px(ã„ã„ã­height) + 6px(gap) */
        right:6px;
      }
      #share-btns.raised{
        bottom:306px; /* ã‚µãƒ ãƒã‚¤ãƒ«é«˜ã•140px + å…ƒã®bottom 166px */
      }
      .share-btn{
        width:50px;
        height:50px;
        font-size:18px;
      }

      /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆä¸­å¤®ã§ã¯ãªãã€SNSãƒœã‚¿ãƒ³ã®ä¸Šã«é…ç½®ï¼‰ */
      #filter-controls{
        top:auto;
        bottom:334px; /* 166px(SNSbottom) + 162px(SNSå…¨ä½“height) + 6px(gap) */
        transform:none;
        right:6px;
      }
      #filter-all, #filter-liked{
        width:50px;
        height:50px;
        font-size:20px;
      }

      /* ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ç”»é¢ */
      #opening-logo{
        max-width:200px;
      }
      #opening h1{
        font-size:20px;
      }
      #opening .sub{
        font-size:12px;
      }
      #opening .tagline{
        font-size:11px;
      }
    }
  </style>
</head>
<body>
  <!-- Config file is no longer needed - using Vercel API instead -->

  <div id="progress-bar"><div id="progress-fill"></div></div>
  <div id="stage" aria-label="ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼é ˜åŸŸ"></div>

  <!-- ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ç”»é¢ -->
  <div id="opening">
    <div id="opening-content">
      <img src="tarobo-logo-white.png" alt="TAROBO CHALLENGE" id="opening-logo">
      <h1>æ­´å²ã‚’é§†ã‘æŠœã‘ã€æœªæ¥ã‚’æ´ã‚</h1>
      <p class="sub">æ´ã‚“ã æ‰‹ã™ã‚Šã«æ®‹ã‚‹ã®ã¯ã€å·±ã®æ±—ã¨æŒ‘æˆ¦ã—ç¶šã‘ã‚‹æ„æ€</p>
      <p class="tagline">å¤ªéƒåŠãƒãƒ£ãƒ¬ãƒ³ã‚¸ 2025<br>æ´ã‚€ã€ãã®ç¬é–“ã®è¨˜éŒ²</p>
      <button id="opening-start" title="ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼ã‚’é–‹å§‹ã—ã¾ã™">ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼ã‚’è¦‹ã‚‹ â†’</button>
      <br>
      <button id="opening-skip" title="ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã™ãã«é–‹å§‹ã—ã¾ã™">Skip</button>
    </div>
  </div>

  <!-- Aboutãƒœã‚¿ãƒ³ -->
  <button id="about-btn" title="ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¤ã„ã¦">â“˜</button>
  <div id="about-panel">
    <h3>About this project</h3>
    <p>å¤ªéƒåŠãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®ã‚¹ãƒ­ãƒ¼ã‚¬ãƒ³ã¯<br>ã€Œ<strong>æ­´å²ã‚’é§†ã‘æŠœã‘ã€æœªæ¥ã‚’æ´ã‚ï¼</strong>ã€</p>
    <p>379æ®µã®çŸ³æ®µã‚’é§†ã‘ä¸ŠãŒã‚‹å‚åŠ è€…ä¸€äººã²ã¨ã‚Šã®"ã‚ã¨30mã®è¡¨æƒ…"ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚</p>
    <p>å†™ã£ã¦ã„ã‚‹ã®ã¯ã€ãŸã ã®é¡”ã§ã¯ãªãã€é™ç•Œã‚’è¶…ãˆã‚‹ç¬é–“ã®æ„æ€ã§ã™ã€‚</p>
    <p>æ’®å½±ã¯ä¸€äººã®ã‚«ãƒ¡ãƒ©ãƒãƒ³ãŒã€ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã§ä¸€æ—¥ä¸­è¿½ã„ç¶šã‘ã¾ã—ãŸã€‚ã™ã¹ã¦ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼ã‚’æ’®ã‚Šåˆ‡ã‚ŒãŸã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€å†™ã‚‰ãªã‹ã£ãŸäººã®æŒ‘æˆ¦ã‚‚ã€ç§ãŸã¡ã®è¨˜æ†¶ã®ä¸­ã«ç¢ºã‹ã«åˆ»ã¾ã‚Œã¦ã„ã¾ã™ã€‚</p>
    <p>ã“ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼ã¯ã€è†¨å¤§ãªã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã°ã‚ŒãŸ50æšã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã€ã¾ãŸã¯ğŸ”„ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ãŸã³ã€æ–°ãŸãª50ã®è¡¨æƒ…ã¨å‡ºä¼šãˆã¾ã™ã€‚</p>
    <p class="tagline">ã“ã‚Œã¯ã€æœªæ¥ã‚’æ´ã‚‚ã†ã¨ã—ãŸå…¨ã¦ã®äººã®è¨˜éŒ²ã§ã™ã€‚</p>
  </div>

  <!-- çµ±è¨ˆæƒ…å ±ãƒœã‚¿ãƒ³ -->
  <button id="stats-btn" title="ã„ã„ã­çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º">ğŸ“Š</button>
  <div id="stats-panel">
    <h3>ğŸ“Š ã„ã„ã­çµ±è¨ˆ</h3>
    <div id="stats-summary">
      <div class="stat-item">
        <span class="stat-label">ç·ã„ã„ã­æ•°</span>
        <span class="stat-value" id="stat-total">-</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">äººæ°—å†™çœŸæ•°</span>
        <span class="stat-value" id="stat-photos">-</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</span>
        <span class="stat-value" id="stat-users">-</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">å¹³å‡ã„ã„ã­æ•°</span>
        <span class="stat-value" id="stat-avg">-</span>
      </div>
    </div>
    <a href="ranking.html" target="_blank" style="display:block; margin-top:20px; padding:14px 16px; background:linear-gradient(135deg, rgba(0,102,204,0.3), rgba(0,204,255,0.3)); border:2px solid rgba(0,102,204,0.6); border-radius:12px; color:#fff; text-decoration:none; text-align:center; transition:all 0.3s; font-weight:bold; font-size:14px;">
      ğŸ† äººæ°—ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP10ã‚’è¦‹ã‚‹ â†’
    </a>
  </div>

  <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ -->
  <div id="realtime-notify">
    <span class="notify-icon">â¤ï¸</span>
    <span id="realtime-message">èª°ã‹ãŒã„ã„ã­ã—ã¾ã—ãŸï¼</span>
  </div>

  <div id="image-info">
    <div id="counter">-/-</div>
    <div id="filename">-</div>
  </div>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ -->
  <div id="filter-controls">
    <button id="filter-all" class="active" title="å…¨ã¦ã®å†™çœŸã‚’è¡¨ç¤ºã—ã¾ã™">ğŸ“·</button>
    <button id="filter-liked" title="ã„ã„ã­ã—ãŸå†™çœŸã ã‘ã‚’è¡¨ç¤ºã—ã¾ã™">ğŸ¤</button>
  </div>

  <!-- ã„ã„ã­ãƒœã‚¿ãƒ³ -->
  <button id="like-btn" title="ã“ã®å†™çœŸã«ã„ã„ã­ï¼ï¼ˆLã‚­ãƒ¼ï¼‰" data-tooltip="ã„ã„ã­">
    ğŸ©¶
    <span id="like-count">0</span>
  </button>

  <!-- Instagramé¢¨ã„ã„ã­é€šçŸ¥ -->
  <div id="like-notification">
    <div id="like-notification-content"></div>
  </div>

  <!-- SNSã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ -->
  <div id="share-btns">
    <button class="share-btn" id="share-twitter" title="ã“ã®å†™çœŸã‚’Twitterã§ã‚·ã‚§ã‚¢">ğ•</button>
    <button class="share-btn" id="share-facebook" title="ã“ã®å†™çœŸã‚’Facebookã§ã‚·ã‚§ã‚¢">f</button>
    <button class="share-btn" id="share-line" title="ã“ã®å†™çœŸã‚’LINEã§ã‚·ã‚§ã‚¢">L</button>
  </div>

  <!-- ã‚µãƒ ãƒã‚¤ãƒ«ä¸€è¦§ -->
  <div id="thumbnails-container">
    <div id="thumbnails-wrapper"></div>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç”»åƒæ‹¡å¤§ï¼‰ -->
  <div id="modal">
    <button id="modal-close">Ã—</button>
    <button id="modal-like-btn">ğŸ¤</button>
    <img id="modal-img" src="" alt="æ‹¡å¤§ç”»åƒ">
  </div>

  <div id="hud">
    <div id="bgm-controls">
      <button id="bgm-toggle" title="BGMã‚’ON/OFFã—ã¾ã™">ğŸµ BGM</button>
      <input type="range" id="bgm-volume" min="0" max="100" value="50" title="BGMã®éŸ³é‡ã‚’èª¿æ•´ã—ã¾ã™">
    </div>
    <button id="thumbnails-toggle" title="å…¨ã¦ã®å†™çœŸã‚’ä¸€è¦§è¡¨ç¤ºã—ã¾ã™ï¼ˆTã‚­ãƒ¼ï¼‰">ğŸ“¸ å†™çœŸä¸€è¦§</button>
    <span id="info">source=1146 / showing=50</span>
  </div>

  <!-- BGMç”¨ã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¦ç´  -->
  <audio id="bgm-audio" loop>
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
  </audio>

  <script>
  // ===== è¨­å®š =====
  // Vercel FunctionsçµŒç”±ã§Google Drive APIã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™
  // ç’°å¢ƒå¤‰æ•°ã¯Vercelã®è¨­å®šã§ç®¡ç†ã•ã‚Œã¾ã™

  const COUNT = 50;     // è¡¨ç¤ºæšæ•°
  const FADE_MS = 1200;  // ãƒ•ã‚§ãƒ¼ãƒ‰æ™‚é–“
  const PRELOAD_COUNT = 2;

  // ã‚¹ãƒ”ãƒ¼ãƒ‰è¨­å®š
  const SPEEDS = {
    slow: 6000,
    normal: 3500,
    fast: 1500
  };

  let SHOW_MS = SPEEDS.normal;
  let currentSpeed = 'normal';

  document.documentElement.style.setProperty('--fade-ms', FADE_MS);
  document.documentElement.style.setProperty('--show-ms', SHOW_MS);

  let slides = [], idx = 0, timer = null, running = false, progressTimer = null;
  let fileList = []; // ãƒ•ã‚¡ã‚¤ãƒ«åä¿å­˜ç”¨
  let currentEffect = 'fade'; // ç¾åœ¨ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
  let likedImages = new Set(); // ã„ã„ã­ã—ãŸç”»åƒã®photoIdï¼ˆGoogle Drive IDï¼‰
  let imageLikeCounts = {}; // å„ç”»åƒã®ã„ã„ã­æ•°ã‚’ä¿å­˜ {photoId: count}
  let bgmAudio = null; // BGMã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¦ç´ 
  let allSlides = []; // å…¨ã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
  let allPhotosData = []; // å…¨ç”»åƒãƒ‡ãƒ¼ã‚¿ï¼ˆ1146æšï¼‰ã‚’ä¿å­˜ {id, name, url}
  let currentFilter = 'all'; // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹
  let thumbnailsVisible = false; // ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºçŠ¶æ…‹

  // Vercel FunctionsçµŒç”±ã§ç”»åƒãƒªã‚¹ãƒˆã‚’å–å¾—
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚Šã€429ã‚¨ãƒ©ãƒ¼ã‚’é˜²ãã¾ã™
  async function fetchList(){
    try {
      // Vercel Functionsã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™
      const apiUrl = '/api/photos';

      console.log('Fetching photos from API...');

      const res = await fetch(apiUrl);
      if (!res.ok) {
        throw new Error(`API Error: ${res.status} ${res.statusText}`);
      }

      const result = await res.json();

      if (!result.success) {
        throw new Error(result.error || 'Unknown error');
      }

      // å…¨ç”»åƒãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ ã«50æšé¸æŠ
      const allPhotos = result.files;

      // å…¨ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ï¼ˆã„ã„ã­ãƒ•ã‚£ãƒ«ã‚¿ç”¨ï¼‰
      allPhotosData = allPhotos.map(f => ({
        id: f.id,
        name: f.name,
        url: `https://drive.google.com/thumbnail?id=${f.id}&sz=w1200`
      }));

      const shuffled = [...allPhotos].sort(() => Math.random() - 0.5);
      const picked = shuffled.slice(0, COUNT);

      console.log(`âœ… Loaded ${result.total} total images, randomly picked ${picked.length} photos`);
      if (result.cached) {
        console.log(`ğŸ“¦ Cache age: ${result.cacheAge} seconds`);
      }

      return {
        all: result.total,
        pick: picked
      };

    } catch (error) {
      console.error('Failed to fetch photos:', error);

      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥Google Drive APIã‚’å‘¼ã³å‡ºã™ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
      console.log('Falling back to direct Google Drive API...');
      return fetchListDirect();
    }
  }

  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨: ç›´æ¥Google Drive APIã‚’å‘¼ã³å‡ºã™ï¼ˆconfig.jsãŒå¿…è¦ï¼‰
  async function fetchListDirect(){
    if (typeof CONFIG === 'undefined' || !CONFIG.API_KEY) {
      throw new Error('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚config.jsã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }

    let allFiles = [];
    let pageToken = null;

    do {
      const params = {
        q: `'${CONFIG.FOLDER_ID}' in parents and (mimeType contains 'image/')`,
        key: CONFIG.API_KEY,
        fields: 'files(id,name,mimeType,webContentLink),nextPageToken',
        pageSize: '1000',
        orderBy: 'name'
      };

      if (pageToken) {
        params.pageToken = pageToken;
      }

      const url = `https://www.googleapis.com/drive/v3/files?` + new URLSearchParams(params);

      const res = await fetch(url);
      if (!res.ok) {
        const error = await res.json();
        throw new Error(`API Error: ${error.error?.message || 'Unknown error'}`);
      }

      const data = await res.json();
      allFiles = allFiles.concat(data.files || []);
      pageToken = data.nextPageToken;

    } while (pageToken);

    const shuffled = allFiles.sort(() => Math.random() - 0.5);
    const pick = shuffled.slice(0, COUNT).map(f => ({
      url: `https://drive.google.com/thumbnail?id=${f.id}&sz=w1200`,
      name: f.name,
      id: f.id
    }));

    return { all: allFiles.length, pick };
  }

  function createSlides(list){
    const stage = document.getElementById('stage');
    stage.innerHTML = '';
    slides = [];
    fileList = list; // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’ä¿å­˜
    let added = 0;
    list.forEach((f, i) => {
      if (added >= COUNT) return;
      const img = document.createElement('img');
      img.src = f.url;
      img.alt = f.name || `photo-${i+1}`;
      img.className = 'slide';
      img.dataset.index = i; // é…åˆ—å†…ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿å­˜
      img.dataset.photoId = f.id; // Google Drive IDã‚’ä¿å­˜
      if (i >= PRELOAD_COUNT) img.loading = 'lazy';
      img.onerror = () => { img.remove(); }; // 403ç­‰ã¯é™¤å»
      img.onload = () => { added++; };       // èª­ã‚ãŸã‚‚ã®ã ã‘ã‚«ã‚¦ãƒ³ãƒˆ
      stage.appendChild(img);
      slides.push(img);
    });
    allSlides = [...slides]; // å…¨ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä¿å­˜
    createThumbnails(list); // ã‚µãƒ ãƒã‚¤ãƒ«ã‚’ç”Ÿæˆ
  }

  // ã‚µãƒ ãƒã‚¤ãƒ«ä¸€è¦§ã‚’ç”Ÿæˆ
  function createThumbnails(list){
    const wrapper = document.getElementById('thumbnails-wrapper');
    wrapper.innerHTML = '';

    // ã„ã„ã­ãƒ•ã‚£ãƒ«ã‚¿ä¸­ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
    const isLikedFilter = currentFilter === 'liked';

    // listãŒã‚¹ãƒ©ã‚¤ãƒ‰è¦ç´ ã®é…åˆ—ã®å ´åˆã¨ã€ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã®é…åˆ—ã®å ´åˆãŒã‚ã‚‹
    list.forEach((f, i) => {
      // ã‚µãƒ ãƒã‚¤ãƒ«ã‚³ãƒ³ãƒ†ãƒŠï¼ˆã„ã„ã­ãƒœã‚¿ãƒ³ã‚’é…ç½®ã™ã‚‹ãŸã‚ï¼‰
      const container = document.createElement('div');
      container.className = 'thumbnail-container';

      const thumb = document.createElement('img');

      // ã‚¹ãƒ©ã‚¤ãƒ‰è¦ç´ ã®å ´åˆ
      if (f instanceof HTMLImageElement) {
        thumb.src = f.src;
        thumb.alt = f.alt;
        thumb.dataset.index = i;
        thumb.dataset.photoId = f.dataset.photoId;

        // photoIdã§ã„ã„ã­çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        if (likedImages.has(f.dataset.photoId)) {
          thumb.classList.add('liked');
        }
      } else {
        // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã®å ´åˆï¼ˆåˆå›èª­ã¿è¾¼ã¿æ™‚ï¼‰
        thumb.src = f.url;
        thumb.alt = f.name || `thumb-${i+1}`;
        thumb.dataset.index = i;
        thumb.dataset.photoId = f.id;

        if (likedImages.has(f.id)) {
          thumb.classList.add('liked');
        }
      }

      thumb.className = 'thumbnail';

      // ã‚¯ãƒªãƒƒã‚¯ã§è©²å½“ç”»åƒã«ã‚¸ãƒ£ãƒ³ãƒ—
      thumb.onclick = () => jumpToSlide(i);

      container.appendChild(thumb);

      // ã„ã„ã­ãƒ•ã‚£ãƒ«ã‚¿ä¸­ã®å ´åˆã€â¤ï¸è§£é™¤ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
      if (isLikedFilter) {
        const likeBtn = document.createElement('button');
        likeBtn.className = 'thumbnail-like-btn';
        likeBtn.innerHTML = 'â¤ï¸';
        likeBtn.title = 'ã„ã„ã­è§£é™¤';

        likeBtn.onclick = async (e) => {
          e.stopPropagation(); // ã‚µãƒ ãƒã‚¤ãƒ«ã‚¯ãƒªãƒƒã‚¯ã¨å¹²æ¸‰ã—ãªã„ã‚ˆã†ã«

          const photoId = thumb.dataset.photoId;
          if (!photoId) return;

          // ã„ã„ã­è§£é™¤
          await removeLikeFromThumbnail(photoId, container);
        };

        container.appendChild(likeBtn);
      }

      wrapper.appendChild(container);
    });

    updateActiveThumbnail();
  }

  // ã‚µãƒ ãƒã‚¤ãƒ«ã‹ã‚‰ã„ã„ã­è§£é™¤
  async function removeLikeFromThumbnail(photoId, containerElement) {
    try {
      // APIã§ã„ã„ã­è§£é™¤
      const response = await fetch(`/api/like?photoId=${photoId}`, {
        method: 'DELETE'
      });

      const result = await response.json();

      if (result.success) {
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰å‰Šé™¤
        likedImages.delete(photoId);
        imageLikeCounts[photoId] = result.count || 0;

        // ã‚µãƒ ãƒã‚¤ãƒ«ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã—ã¦å‰Šé™¤
        containerElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        containerElement.style.opacity = '0';
        containerElement.style.transform = 'scale(0.8)';

        setTimeout(() => {
          containerElement.remove();

          // ã„ã„ã­ãƒ•ã‚£ãƒ«ã‚¿ä¸­ã®ã‚¹ãƒ©ã‚¤ãƒ‰é…åˆ—ã‹ã‚‰å‰Šé™¤
          const photoIndex = slides.findIndex(slide => slide.dataset.photoId === photoId);
          if (photoIndex !== -1) {
            slides[photoIndex].remove(); // DOM ã‹ã‚‰å‰Šé™¤
            slides.splice(photoIndex, 1); // é…åˆ—ã‹ã‚‰å‰Šé™¤
            fileList.splice(photoIndex, 1); // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‹ã‚‰ã‚‚å‰Šé™¤

            // ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’èª¿æ•´
            if (idx >= slides.length) {
              idx = Math.max(0, slides.length - 1);
            }

            // ç”»åƒæƒ…å ±ã‚’æ›´æ–°
            if (slides.length > 0) {
              slides.forEach(s => s.classList.remove('active'));
              slides[idx].classList.add('active');
              updateImageInfo();
            } else {
              // ã„ã„ã­ã—ãŸå†™çœŸãŒå…¨ã¦ç„¡ããªã£ãŸå ´åˆã€å…¨è¡¨ç¤ºã«æˆ»ã™
              alert('ã„ã„ã­ã—ãŸå†™çœŸãŒå…¨ã¦è§£é™¤ã•ã‚Œã¾ã—ãŸã€‚\nå…¨è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã™ã€‚');
              document.getElementById('filter-all').click();
            }
          }
        }, 300);

        saveLikesToStorage();
      }
    } catch (error) {
      console.error('Failed to remove like:', error);
      alert('ã„ã„ã­è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    }
  }

  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ ãƒã‚¤ãƒ«ã‚’æ›´æ–°
  function updateActiveThumbnail(){
    document.querySelectorAll('.thumbnail').forEach((thumb, i) => {
      thumb.classList.toggle('active', i === idx);
      // ã„ã„ã­çŠ¶æ…‹ã‚‚æ›´æ–°ï¼ˆphotoIdã‚’ä½¿ç”¨ï¼‰
      const photoId = thumb.dataset.photoId;
      thumb.classList.toggle('liked', likedImages.has(photoId));
    });
  }

  // ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
  function toggleThumbnails(){
    thumbnailsVisible = !thumbnailsVisible;
    const container = document.getElementById('thumbnails-container');
    const btn = document.getElementById('thumbnails-toggle');
    const hud = document.getElementById('hud');
    const likeBtn = document.getElementById('like-btn');
    const shareBtns = document.getElementById('share-btns');

    container.classList.toggle('show', thumbnailsVisible);
    hud.classList.toggle('raised', thumbnailsVisible);
    likeBtn.classList.toggle('raised', thumbnailsVisible);
    shareBtns.classList.toggle('raised', thumbnailsVisible);

    // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆ
    if (thumbnailsVisible) {
      btn.textContent = 'âœ• é–‰ã˜ã‚‹';

      // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ã«å¿œã˜ã¦ã‚µãƒ ãƒã‚¤ãƒ«ã‚’å†ç”Ÿæˆ
      if (currentFilter === 'liked') {
        // ã„ã„ã­ãƒ•ã‚£ãƒ«ã‚¿ä¸­ã¯ã€ã„ã„ã­ã—ãŸå†™çœŸã ã‘ã‚’è¡¨ç¤º
        createThumbnails(slides);
      } else {
        // å…¨è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€å…¨å†™çœŸã‚’è¡¨ç¤º
        createThumbnails(slides);
      }

      updateActiveThumbnail();
      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ ãƒã‚¤ãƒ«ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      const activeThumbnail = document.querySelector('.thumbnail.active');
      if (activeThumbnail) {
        activeThumbnail.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      }
    } else {
      btn.textContent = 'ğŸ“¸ å†™çœŸä¸€è¦§';
    }
  }

  // æŒ‡å®šã—ãŸã‚¹ãƒ©ã‚¤ãƒ‰ã«ã‚¸ãƒ£ãƒ³ãƒ—
  function jumpToSlide(targetIdx){
    if (slides.length === 0 || targetIdx < 0 || targetIdx >= slides.length) return;

    const wasRunning = running;
    if (running) pause();

    // ç¾åœ¨ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’éè¡¨ç¤º
    const curr = slides[idx];

    // æ–°ã—ã„ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è¡¨ç¤º
    idx = targetIdx;

    // ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰
    curr.classList.remove('active');
    slides[idx].classList.add('active');
    updateImageInfo();
    updateActiveThumbnail();

    if (wasRunning) play();
  }

  // ç”»åƒæƒ…å ±ã‚’æ›´æ–°
  async function updateImageInfo(){
    document.getElementById('counter').textContent = `${idx + 1} / ${slides.length}`;
    document.getElementById('filename').textContent = fileList[idx]?.name || '-';

    // APIã‹ã‚‰ã„ã„ã­æ•°ã‚’å–å¾—ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œï¼‰
    const currentFile = fileList[idx];
    if (currentFile && currentFile.id) {
      fetchLikeCount(currentFile.id);
    }

    updateLikeButton();
    updateActiveThumbnail();
  }

  // APIã‹ã‚‰ã„ã„ã­æ•°ã‚’å–å¾—
  async function fetchLikeCount(photoId){
    try {
      const response = await fetch(`/api/like?photoId=${photoId}`);
      const result = await response.json();

      if (result.success) {
        imageLikeCounts[photoId] = result.count || 0;
        if (result.liked) {
          likedImages.add(photoId);
        } else {
          likedImages.delete(photoId);
        }
        // ç¾åœ¨è¡¨ç¤ºä¸­ã®ç”»åƒãªã‚‰æ›´æ–°
        const currentFile = fileList[idx];
        if (currentFile && currentFile.id === photoId) {
          updateLikeButton();
          updateActiveThumbnail();
        }
      }
    } catch (error) {
      console.error('Failed to fetch like count:', error);
    }
  }

  // ã„ã„ã­ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
  function updateLikeButton(){
    const likeBtn = document.getElementById('like-btn');
    const currentFile = fileList[idx];
    if (!currentFile || !currentFile.id) return;

    const photoId = currentFile.id;
    const currentLikes = imageLikeCounts[photoId] || 0;

    console.log(`updateLikeButton: photoId=${photoId}, likes=${currentLikes}, liked=${likedImages.has(photoId)}`);

    // ã„ã„ã­æ•°ãŒ0ã®å ´åˆã¯ãƒãƒƒã‚¸ã‚’éè¡¨ç¤º
    const countBadge = currentLikes > 0 ? `<span id="like-count">${currentLikes}</span>` : '';

    if (likedImages.has(photoId)) {
      // ã„ã„ã­æ¸ˆã¿: èµ¤ã„ãƒãƒ¼ãƒˆ
      likeBtn.innerHTML = `â¤ï¸${countBadge}`;
    } else {
      // æœªã„ã„ã­: ç™½ã„ãƒãƒ¼ãƒˆ
      likeBtn.innerHTML = `ğŸ¤${countBadge}`;
    }
  }

  // ã„ã„ã­æ©Ÿèƒ½ï¼ˆSupabaseé€£æºï¼‰
  async function toggleLike(){
    const likeBtn = document.getElementById('like-btn');
    const currentFile = fileList[idx];

    if (!currentFile || !currentFile.id) {
      console.error('No file selected');
      return;
    }

    const photoId = currentFile.id;
    const isLiked = likedImages.has(photoId);

    try {
      if (isLiked) {
        // ã„ã„ã­ã‚’å–ã‚Šæ¶ˆã™
        const response = await fetch(`/api/like?photoId=${photoId}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          likedImages.delete(photoId);
          imageLikeCounts[photoId] = result.count || 0;
        }
      } else {
        // ã„ã„ã­ã‚’è¿½åŠ 
        const response = await fetch('/api/like', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ photoId })
        });

        const result = await response.json();

        if (result.success) {
          likedImages.add(photoId);
          imageLikeCounts[photoId] = result.count || 1;

          // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆAndroidã®ã¿å¯¾å¿œã€iOSã¯éå¯¾å¿œï¼‰
          try {
            if ('vibrate' in navigator) {
              navigator.vibrate([50]); // ã‚·ãƒ³ãƒ—ãƒ«ã«50msæŒ¯å‹•
            }
          } catch (e) {
            console.log('Vibration not supported');
          }
        }
      }

      updateLikeButton();
      updateActiveThumbnail();
      saveLikesToStorage(); // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

    } catch (error) {
      console.error('Failed to toggle like:', error);
      // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿æ›´æ–°ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œï¼‰
      if (isLiked) {
        likedImages.delete(photoId);
      } else {
        likedImages.add(photoId);

        // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆAndroidã®ã¿å¯¾å¿œã€iOSã¯éå¯¾å¿œï¼‰
        try {
          if ('vibrate' in navigator) {
            navigator.vibrate([50]);
          }
        } catch (e) {
          console.log('Vibration not supported');
        }
      }
      updateLikeButton();
      saveLikesToStorage();
    }
  }

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
  async function filterSlides(filter){
    currentFilter = filter;
    const wasRunning = running;
    if (running) pause();

    // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    document.getElementById('filter-all').classList.toggle('active', filter === 'all');
    document.getElementById('filter-liked').classList.toggle('active', filter === 'liked');

    if (filter === 'liked') {
      // ã„ã„ã­ã—ãŸå†™çœŸã ã‘ã‚’è¡¨ç¤ºï¼ˆå…¨1146æšã‹ã‚‰æ¤œç´¢ï¼‰
      const likedPhotoIds = Array.from(likedImages);
      if (likedPhotoIds.length === 0) {
        alert('ã¾ã ã„ã„ã­ã—ãŸå†™çœŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚\næ°—ã«å…¥ã£ãŸå†™çœŸã«ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼');
        document.getElementById('filter-all').click();
        return;
      }

      // å…¨ç”»åƒãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã„ã„ã­ã—ãŸå†™çœŸã‚’æŠ½å‡º
      const likedPhotos = allPhotosData.filter(photo => likedImages.has(photo.id));

      if (likedPhotos.length === 0) {
        alert('ã„ã„ã­ã—ãŸå†™çœŸãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
        document.getElementById('filter-all').click();
        return;
      }

      // ã„ã„ã­ã—ãŸå†™çœŸã§æ–°ã—ã„ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä½œæˆ
      const stage = document.getElementById('stage');
      stage.innerHTML = '';
      slides = [];
      fileList = likedPhotos;

      likedPhotos.forEach((f, i) => {
        const img = document.createElement('img');
        img.src = f.url;
        img.alt = f.name || `photo-${i+1}`;
        img.className = 'slide';
        img.dataset.index = i;
        img.dataset.photoId = f.id;
        img.loading = 'lazy';
        stage.appendChild(img);
        slides.push(img);
      });

      idx = 0;
      console.log(`âœ… ã„ã„ã­ãƒ•ã‚£ãƒ«ã‚¿: ${likedPhotos.length}æšã®å†™çœŸã‚’è¡¨ç¤º`);
    } else {
      // å…¨ã¦ã®å†™çœŸã‚’è¡¨ç¤ºï¼ˆå…ƒã®ãƒ©ãƒ³ãƒ€ãƒ 50æšã«æˆ»ã™ï¼‰
      slides = [...allSlides];
      fileList = slides.map(slide => ({
        id: slide.dataset.photoId,
        name: slide.alt,
        url: slide.src
      }));
      idx = 0;
    }

    // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å†è¡¨ç¤º
    document.querySelectorAll('.slide').forEach(s => s.classList.remove('active'));
    if (slides[idx]) {
      slides[idx].classList.add('active');
      updateImageInfo();
    }

    // ã‚µãƒ ãƒã‚¤ãƒ«ãŒè¡¨ç¤ºä¸­ãªã‚‰å†ç”Ÿæˆ
    if (thumbnailsVisible) {
      createThumbnails(slides);
      updateActiveThumbnail();
    }

    if (wasRunning) play();
  }

  // ã„ã„ã­æƒ…å ±ã‚’LocalStorageã«ä¿å­˜
  function saveLikesToStorage(){
    try {
      localStorage.setItem('tarobo-liked-images', JSON.stringify(Array.from(likedImages)));
      localStorage.setItem('tarobo-like-counts', JSON.stringify(imageLikeCounts));
    } catch(e) {
      console.log('LocalStorageä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
    }
  }

  // ã„ã„ã­æƒ…å ±ã‚’LocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿
  function loadLikesFromStorage(){
    try {
      const savedLiked = localStorage.getItem('tarobo-liked-images');
      const savedCounts = localStorage.getItem('tarobo-like-counts');

      if (savedLiked) {
        likedImages = new Set(JSON.parse(savedLiked));
      }
      if (savedCounts) {
        imageLikeCounts = JSON.parse(savedCounts);
      }
    } catch(e) {
      console.log('LocalStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
    }
  }

  // SNSã‚·ã‚§ã‚¢æ©Ÿèƒ½ï¼ˆç¾åœ¨è¡¨ç¤ºä¸­ã®ç”»åƒã‚’ã‚·ã‚§ã‚¢ï¼‰
  function shareToSNS(platform){
    if (slides.length === 0) return;

    // ç¾åœ¨è¡¨ç¤ºä¸­ã®ç”»åƒæƒ…å ±ã‚’å–å¾—
    const currentImage = fileList[idx];
    const imageUrl = encodeURIComponent(slides[idx].src);
    const shareText = encodeURIComponent('çŸ³æ®µã‚’é§†ã‘æŠœã‘ã€æœªæ¥ã‚’æ´ã‚€ï½œå¤ªéƒåŠãƒãƒ£ãƒ¬ãƒ³ã‚¸2025\n379æ®µã®æŒ‘æˆ¦è€…ãŸã¡');
    const hashtags = encodeURIComponent('å¤ªéƒåŠãƒãƒ£ãƒ¬ãƒ³ã‚¸');

    let url = '';

    switch(platform) {
      case 'twitter':
        // Twitterã¯ç”»åƒURLã¨ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’å«ã‚ã‚‹
        url = `https://twitter.com/intent/tweet?text=${shareText}&hashtags=${hashtags}&url=${imageUrl}`;
        break;
      case 'facebook':
        // Facebookã¯ç”»åƒURLã‚’å…±æœ‰
        url = `https://www.facebook.com/sharer/sharer.php?u=${imageUrl}`;
        break;
      case 'line':
        // LINEã¯ç”»åƒURLã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’å…±æœ‰
        url = `https://social-plugins.line.me/lineit/share?url=${imageUrl}&text=${shareText}`;
        break;
    }

    if (url) {
      window.open(url, '_blank', 'width=600,height=400');
      // ã‚·ã‚§ã‚¢ã—ãŸã“ã¨ã‚’è¦–è¦šçš„ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
      const btn = event.target.closest('.share-btn');
      if (btn) {
        btn.style.transform = 'scale(1.2)';
        setTimeout(() => btn.style.transform = '', 300);
      }
    }
  }

  // ç”»åƒæ‹¡å¤§è¡¨ç¤º
  function openModal(){
    if (slides.length === 0) return;
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modal-img');
    modalImg.src = slides[idx].src;
    modal.classList.add('show');
    updateModalLikeButton();
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã„ã„ã­ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
  function updateModalLikeButton(){
    const modalLikeBtn = document.getElementById('modal-like-btn');
    const currentFile = fileList[idx];
    if (!currentFile || !currentFile.id) return;

    if (likedImages.has(currentFile.id)) {
      modalLikeBtn.textContent = 'â¤ï¸';
      modalLikeBtn.classList.add('liked');
    } else {
      modalLikeBtn.textContent = 'ğŸ¤';
      modalLikeBtn.classList.remove('liked');
    }
  }

  function closeModal(){
    const modal = document.getElementById('modal');
    modal.classList.remove('show');
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã§æ¬¡/å‰ã®ç”»åƒã«é·ç§»
  function showNextInModal(){
    nextSlide();
    const modalImg = document.getElementById('modal-img');
    modalImg.src = slides[idx].src;
    updateModalLikeButton();
  }

  function showPrevInModal(){
    prevSlide();
    const modalImg = document.getElementById('modal-img');
    modalImg.src = slides[idx].src;
    updateModalLikeButton();
  }

  // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’é©ç”¨
  function applyEffect(element, effect){
    // æ—¢å­˜ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚¯ãƒ©ã‚¹ã‚’ã‚¯ãƒªã‚¢
    element.classList.remove('effect-slide-left', 'effect-slide-right', 'effect-zoom', 'effect-rotate');

    if (effect === 'random') {
      const effects = ['fade', 'slide-left', 'slide-right', 'zoom', 'rotate'];
      effect = effects[Math.floor(Math.random() * effects.length)];
    }

    if (effect !== 'fade') {
      // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ï¼ˆactiveã®å‰ã«ï¼‰
      element.classList.add(`effect-${effect}`);
      // ãƒ–ãƒ©ã‚¦ã‚¶ã«åˆæœŸçŠ¶æ…‹ã‚’èªè­˜ã•ã›ã‚‹ãŸã‚ã€å¼·åˆ¶çš„ã«ãƒªãƒ•ãƒ­ãƒ¼
      void element.offsetWidth;
    }
  }

  // é€²æ—ãƒãƒ¼ã‚’æ›´æ–°
  function startProgressBar(){
    if (progressTimer) clearInterval(progressTimer);
    const fill = document.getElementById('progress-fill');
    let progress = 0;
    const step = 100 / (SHOW_MS / 100);

    fill.style.width = '0%';
    progressTimer = setInterval(() => {
      progress += step;
      if (progress >= 100) {
        progress = 0;
      }
      fill.style.width = `${progress}%`;
    }, 100);
  }

  function stopProgressBar(){
    if (progressTimer) {
      clearInterval(progressTimer);
      progressTimer = null;
    }
    document.getElementById('progress-fill').style.width = '0%';
  }


  function play(){
    if (running || slides.length === 0) return;
    running = true;
    if (!slides[idx].classList.contains('active')) {
      slides[idx].classList.add('active');
    }
    updateImageInfo();
    startProgressBar();

    timer = setInterval(()=>{
      const curr = slides[idx];
      idx = (idx + 1) % slides.length;
      const next = slides[idx];

      // ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰: å‰ã®ç”»åƒã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã€æ¬¡ã®ç”»åƒã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
      console.log('Transition:', curr, 'to', next); // ãƒ‡ãƒãƒƒã‚°ç”¨
      curr.classList.remove('active');
      next.classList.add('active');
      updateImageInfo();
    }, SHOW_MS);
  }

  function pause(){
    running = false;
    clearInterval(timer);
    timer = null;
    stopProgressBar();
  }

  // æ¬¡ã®ç”»åƒã¸
  function nextSlide(){
    if (slides.length === 0) return;
    const wasRunning = running;
    if (running) pause();

    const curr = slides[idx];
    idx = (idx + 1) % slides.length;
    const next = slides[idx];

    // ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰
    curr.classList.remove('active');
    next.classList.add('active');
    updateImageInfo();

    if (wasRunning) play();
  }

  // å‰ã®ç”»åƒã¸
  function prevSlide(){
    if (slides.length === 0) return;
    const wasRunning = running;
    if (running) pause();

    const curr = slides[idx];
    idx = (idx - 1 + slides.length) % slides.length;
    const next = slides[idx];

    // ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰
    curr.classList.remove('active');
    next.classList.add('active');
    updateImageInfo();

    if (wasRunning) play();
  }

  // ã‚¹ãƒ”ãƒ¼ãƒ‰å¤‰æ›´
  function changeSpeed(speed){
    SHOW_MS = SPEEDS[speed];
    currentSpeed = speed;
    document.documentElement.style.setProperty('--show-ms', SHOW_MS);

    // ãƒœã‚¿ãƒ³ã®activeçŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('#speed-controls button').forEach(btn => {
      btn.classList.remove('active');
    });
    document.getElementById(`btn-speed-${speed}`).classList.add('active');

    // å†ç”Ÿä¸­ãªã‚‰å†èµ·å‹•
    if (running) {
      pause();
      play();
    }
  }

  async function init(){
    try{
      // LocalStorageã‹ã‚‰ã„ã„ã­æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
      loadLikesFromStorage();

      const {all, pick} = await fetchList();
      createSlides(pick);
      document.getElementById('info').textContent = `source=${all} / showing=${pick.length}`;
      play();
    }catch(e){
      document.getElementById('info').textContent = 'èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
      console.error(e);
    }
  }

  // BGMæ©Ÿèƒ½
  function initBGM(){
    bgmAudio = document.getElementById('bgm-audio');
    bgmAudio.volume = 0.5;

    document.getElementById('bgm-toggle').onclick = () => {
      const btn = document.getElementById('bgm-toggle');
      if (bgmAudio.paused) {
        bgmAudio.play().catch(e => console.log('BGMå†ç”Ÿã‚¨ãƒ©ãƒ¼:', e));
        btn.classList.add('playing');
        btn.textContent = 'ğŸµ BGMåœæ­¢';
      } else {
        bgmAudio.pause();
        btn.classList.remove('playing');
        btn.textContent = 'ğŸµ BGM';
      }
    };

    document.getElementById('bgm-volume').oninput = (e) => {
      bgmAudio.volume = e.target.value / 100;
    };
  }

  // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  // Play/Pause/Shuffleãƒœã‚¿ãƒ³ã¯å‰Šé™¤æ¸ˆã¿ï¼ˆç”»é¢ã‚¿ãƒƒãƒ—ã§å†ç”Ÿ/ä¸€æ™‚åœæ­¢ï¼‰

  // ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
  // é€Ÿåº¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¯å‰Šé™¤æ¸ˆã¿

  // ã„ã„ã­ãƒœã‚¿ãƒ³
  document.getElementById('like-btn').onclick = toggleLike;

  // SNSã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³
  document.getElementById('share-twitter').onclick = () => shareToSNS('twitter');
  document.getElementById('share-facebook').onclick = () => shareToSNS('facebook');
  document.getElementById('share-line').onclick = () => shareToSNS('line');

  // ãƒ¢ãƒ¼ãƒ€ãƒ«
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¯ãƒªãƒƒã‚¯ãƒ»ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
  const modal = document.getElementById('modal');
  const modalImg = document.getElementById('modal-img');

  // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  modal.onclick = (e) => {
    if (e.target === modal) closeModal();
  };
  document.getElementById('modal-close').onclick = closeModal;

  // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã„ã„ã­ãƒœã‚¿ãƒ³
  document.getElementById('modal-like-btn').onclick = async (e) => {
    e.stopPropagation(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ãªã„ã‚ˆã†ã«ã™ã‚‹
    const modalLikeBtn = document.getElementById('modal-like-btn');

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯toggleLikeå†…ã§å‡¦ç†ã•ã‚Œã‚‹ãŒã€
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒœã‚¿ãƒ³ã«ã‚‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
    const currentFile = fileList[idx];
    if (!currentFile || !currentFile.id) return;

    const wasLiked = likedImages.has(currentFile.id);
    await toggleLike();

    if (!wasLiked) {
      // ã„ã„ã­ã‚’è¿½åŠ ã—ãŸå ´åˆã®ã¿ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      modalLikeBtn.classList.add('liked');
      setTimeout(() => modalLikeBtn.classList.remove('liked'), 600);
    }

    updateModalLikeButton();
  };

  // ãƒ•ãƒªãƒƒã‚¯æ¤œå‡ºç”¨ã®å¤‰æ•°
  let touchStartX = 0;
  let touchEndX = 0;
  const SWIPE_THRESHOLD = 50; // ã‚¹ãƒ¯ã‚¤ãƒ—ã¨åˆ¤å®šã™ã‚‹æœ€å°è·é›¢ï¼ˆpxï¼‰

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ç”»åƒã«ãƒ•ãƒªãƒƒã‚¯æ©Ÿèƒ½ã‚’è¿½åŠ 
  modalImg.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
  }, { passive: true });

  modalImg.addEventListener('touchend', (e) => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
  }, { passive: true });

  function handleSwipe() {
    const diff = touchStartX - touchEndX;

    if (Math.abs(diff) > SWIPE_THRESHOLD) {
      if (diff > 0) {
        // å·¦ãƒ•ãƒªãƒƒã‚¯ â†’ æ¬¡ã®ç”»åƒ
        showNextInModal();
      } else {
        // å³ãƒ•ãƒªãƒƒã‚¯ â†’ å‰ã®ç”»åƒ
        showPrevInModal();
      }
    }
  }

  // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé¸æŠ
  // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã¯å‰Šé™¤æ¸ˆã¿ï¼ˆå¸¸ã«ãƒ•ã‚§ãƒ¼ãƒ‰ï¼‰

  // ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
  document.getElementById('thumbnails-toggle').onclick = toggleThumbnails;

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³
  document.getElementById('filter-all').onclick = () => filterSlides('all');
  document.getElementById('filter-liked').onclick = () => filterSlides('liked');

  // ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ç”»é¢
  function initOpening(){
    const opening = document.getElementById('opening');

    // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
    document.getElementById('opening-start').onclick = () => {
      opening.classList.add('hide');
      setTimeout(() => opening.style.display = 'none', 800);
    };

    // Skipãƒœã‚¿ãƒ³
    document.getElementById('opening-skip').onclick = () => {
      opening.classList.add('hide');
      setTimeout(() => opening.style.display = 'none', 800);
    };
  }

  // Aboutãƒœã‚¿ãƒ³
  let aboutVisible = false;

  document.getElementById('about-btn').onclick = () => {
    aboutVisible = !aboutVisible;
    const panel = document.getElementById('about-panel');
    panel.classList.toggle('show', aboutVisible);
  };

  // Aboutãƒ‘ãƒãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
  document.addEventListener('click', (e) => {
    const aboutBtn = document.getElementById('about-btn');
    const aboutPanel = document.getElementById('about-panel');

    if (aboutVisible && !aboutBtn.contains(e.target) && !aboutPanel.contains(e.target)) {
      aboutVisible = false;
      aboutPanel.classList.remove('show');
    }
  });

  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
  document.addEventListener('keydown', (e) => {
    switch(e.key) {
      case ' ':           // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼: ä¸€æ™‚åœæ­¢/å†ç”Ÿ
        e.preventDefault();
        if (running) pause();
        else play();
        break;
      case 'ArrowRight':  // å³çŸ¢å°: æ¬¡ã®ç”»åƒ
        e.preventDefault();
        nextSlide();
        break;
      case 'ArrowLeft':   // å·¦çŸ¢å°: å‰ã®ç”»åƒ
        e.preventDefault();
        prevSlide();
        break;
      // é€Ÿåº¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã¯å‰Šé™¤æ¸ˆã¿
      case 'l':           // Lã‚­ãƒ¼: ã„ã„ã­
        e.preventDefault();
        toggleLike();
        break;
      case 'Enter':       // Enterã‚­ãƒ¼: ç”»åƒæ‹¡å¤§
        e.preventDefault();
        if (!document.getElementById('modal').classList.contains('show')) {
          openModal();
        } else {
          closeModal();
        }
        break;
      case 'Escape':      // Escã‚­ãƒ¼: ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        e.preventDefault();
        closeModal();
        break;
      case 't':           // Tã‚­ãƒ¼: ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        e.preventDefault();
        toggleThumbnails();
        break;
      case 'f':           // Fã‚­ãƒ¼: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
        e.preventDefault();
        if (currentFilter === 'all') {
          filterSlides('liked');
        } else {
          filterSlides('all');
        }
        break;
    }
  });

  // ç”»åƒã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§è¡¨ç¤º
  const stage = document.getElementById('stage');
  stage.addEventListener('click', (e) => {
    // ã‚·ãƒ³ã‚°ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§è¡¨ç¤º
    if (e.detail === 1) {
      setTimeout(() => {
        if (e.detail === 1) openModal();
      }, 200);
    }
  });

  // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯/ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³
  stage.addEventListener('dblclick', ()=> {
    if (!document.fullscreenElement) stage.requestFullscreen().catch(()=>{});
    else document.exitFullscreen().catch(()=>{});
  });

  // UIè‡ªå‹•éè¡¨ç¤ºæ©Ÿèƒ½
  let uiHideTimer = null;
  const UI_HIDE_DELAY = 3000; // 3ç§’å¾Œã«UIã‚’éè¡¨ç¤º

  function hideUI() {
    document.getElementById('hud').classList.add('hidden');
    document.getElementById('image-info').classList.add('hidden');
    document.getElementById('like-btn').classList.add('hidden');
    document.getElementById('share-btns').classList.add('hidden');
    document.getElementById('about-btn').classList.add('hidden');
    document.getElementById('stats-btn').classList.add('hidden');
    document.getElementById('filter-controls').classList.add('hidden');
  }

  function showUI() {
    document.getElementById('hud').classList.remove('hidden');
    document.getElementById('image-info').classList.remove('hidden');
    document.getElementById('like-btn').classList.remove('hidden');
    document.getElementById('share-btns').classList.remove('hidden');
    document.getElementById('about-btn').classList.remove('hidden');
    document.getElementById('stats-btn').classList.remove('hidden');
    document.getElementById('filter-controls').classList.remove('hidden');

    // ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
    clearTimeout(uiHideTimer);
    uiHideTimer = setTimeout(hideUI, UI_HIDE_DELAY);
  }

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã¨æ“ä½œæ™‚ã«UIã‚’è¡¨ç¤º
  function resetUITimer() {
    showUI();
  }

  // ãƒã‚¦ã‚¹ç§»å‹•ãƒ»ã‚¿ãƒƒãƒ—ã§UIã‚’è¡¨ç¤º
  document.addEventListener('mousemove', resetUITimer);
  document.addEventListener('touchstart', resetUITimer);
  document.addEventListener('click', resetUITimer);

  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã§ã‚‚UIã‚’è¡¨ç¤º
  document.addEventListener('keydown', resetUITimer);

  // ===== Instagramé¢¨ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§ã„ã„ã­æ©Ÿèƒ½ =====
  let lastTapTime = 0;
  const DOUBLE_TAP_DELAY = 300; // 0.3ç§’ä»¥å†…ã®2å›ã‚¿ãƒƒãƒ—ã‚’æ¤œå‡º

  function setupDoubleTap() {
    const stage = document.getElementById('stage');

    stage.addEventListener('click', async (e) => {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯ç„¡åŠ¹
      const modal = document.getElementById('modal');
      if (modal.classList.contains('show')) {
        return;
      }

      // UIãƒœã‚¿ãƒ³ã‚„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚¯ãƒªãƒƒã‚¯ã¯é™¤å¤–
      if (e.target.id === 'like-btn' ||
          e.target.closest('#like-btn') ||
          e.target.closest('#share-btns') ||
          e.target.closest('#filter-controls') ||
          e.target.closest('#hud')) {
        return;
      }

      const currentTime = new Date().getTime();
      const tapGap = currentTime - lastTapTime;

      if (tapGap < DOUBLE_TAP_DELAY && tapGap > 0) {
        // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ¤œå‡º
        const currentFile = fileList[idx];
        if (!currentFile || !currentFile.id) return;

        const photoId = currentFile.id;
        const isLiked = likedImages.has(photoId);

        // æ—¢ã«ã„ã„ã­æ¸ˆã¿ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆInstagramã¨åŒã˜ï¼‰
        if (!isLiked) {
          // ã„ã„ã­ã‚’è¿½åŠ 
          await toggleLike();

          // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆç”»é¢ä¸­å¤®ã«å¤§ããªãƒãƒ¼ãƒˆï¼‰
          showDoubleTapHeart(e);
        }

        lastTapTime = 0; // ãƒªã‚»ãƒƒãƒˆ
      } else {
        lastTapTime = currentTime;
      }
    });
  }

  // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ™‚ã®å¤§ããªãƒãƒ¼ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆInstagramé¢¨ï¼‰
  function showDoubleTapHeart(event) {
    const heart = document.createElement('div');
    heart.innerHTML = 'â¤ï¸';
    heart.style.cssText = `
      position: fixed;
      font-size: 120px;
      pointer-events: none;
      z-index: 250;
      animation: doubleTapHeart 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      filter: drop-shadow(0 8px 30px rgba(0,0,0,0.5));
    `;

    // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã«è¡¨ç¤º
    const x = event.clientX || window.innerWidth / 2;
    const y = event.clientY || window.innerHeight / 2;
    heart.style.left = (x - 60) + 'px';
    heart.style.top = (y - 60) + 'px';

    document.body.appendChild(heart);

    setTimeout(() => heart.remove(), 800);
  }

  // CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•çš„ã«è¿½åŠ 
  const style = document.createElement('style');
  style.textContent = `
    @keyframes doubleTapHeart {
      0% { transform: scale(0); opacity: 0; }
      15% { transform: scale(1.2); opacity: 1; }
      30% { transform: scale(1); opacity: 1; }
      70% { transform: scale(1); opacity: 1; }
      100% { transform: scale(0.8); opacity: 0; }
    }
  `;
  document.head.appendChild(style);

  // åˆæœŸè¡¨ç¤º
  resetUITimer();
  setupDoubleTap();

  // ===== æ–°æ©Ÿèƒ½: çµ±è¨ˆæƒ…å ±ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ»ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–° =====

  // çµ±è¨ˆæƒ…å ±ãƒ‘ãƒãƒ«
  let statsVisible = false;
  let statsData = null;

  document.getElementById('stats-btn').onclick = async () => {
    statsVisible = !statsVisible;
    const panel = document.getElementById('stats-panel');
    panel.classList.toggle('show', statsVisible);

    // ãƒ‘ãƒãƒ«ã‚’é–‹ããŸã³ã«æœ€æ–°ã®çµ±è¨ˆæƒ…å ±ã‚’å–å¾—
    if (statsVisible) {
      await loadStats();
    }
  };

  // çµ±è¨ˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿
  async function loadStats() {
    try {
      // ã‚µãƒãƒªãƒ¼å–å¾—
      const summaryRes = await fetch('/api/analytics?type=summary');
      const summaryData = await summaryRes.json();

      if (summaryData.success) {
        document.getElementById('stat-total').textContent = summaryData.data.totalLikes;
        document.getElementById('stat-photos').textContent = summaryData.data.uniquePhotos;
        document.getElementById('stat-users').textContent = summaryData.data.uniqueUsers;
        document.getElementById('stat-avg').textContent = summaryData.data.avgLikesPerPhoto.toFixed(1);
      }

      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã¯å–å¾—ã—ãªã„ï¼ˆå°‚ç”¨ãƒšãƒ¼ã‚¸ã«ä»»ã›ã‚‹ï¼‰
      statsData = { summary: summaryData.data };

    } catch (error) {
      console.error('Failed to load stats:', error);
      document.getElementById('stat-total').textContent = 'ã‚¨ãƒ©ãƒ¼';
    }
  }

  // çµ±è¨ˆãƒ‘ãƒãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  document.addEventListener('click', (e) => {
    const statsBtn = document.getElementById('stats-btn');
    const statsPanel = document.getElementById('stats-panel');

    if (statsVisible && !statsBtn.contains(e.target) && !statsPanel.contains(e.target)) {
      statsVisible = false;
      statsPanel.classList.remove('show');
    }
  });

  // ã„ã„ã­ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå¼·åŒ–
  function createEnhancedLikeEffect(element) {
    // ãƒãƒ¼ãƒˆãƒãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    element.style.animation = 'heartPop 0.6s ease-out';
    setTimeout(() => {
      element.style.animation = '';
    }, 600);

    // ãƒªãƒƒãƒ—ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    // NOTE: position:fixedã®ãƒœã‚¿ãƒ³ã«ã¯relativeã‚’è¨­å®šã—ãªã„ï¼ˆä½ç½®ãŒãšã‚Œã‚‹ãŸã‚ï¼‰
    const ripple = document.createElement('div');
    ripple.className = 'ripple-effect';

    // å…ƒã®positionã‚’ä¿å­˜
    const originalPosition = window.getComputedStyle(element).position;

    // fixedä»¥å¤–ã®å ´åˆã®ã¿relativeã‚’è¨­å®š
    if (originalPosition !== 'fixed') {
      element.style.position = 'relative';
    }

    element.appendChild(ripple);
    setTimeout(() => {
      ripple.remove();
      // positionã‚’å…ƒã«æˆ»ã™ï¼ˆå›ºå®šãƒœã‚¿ãƒ³ä»¥å¤–ï¼‰
      if (originalPosition !== 'fixed') {
        element.style.position = '';
      }
    }, 600);

    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒãƒ¼ãƒˆï¼ˆãƒ©ãƒ³ãƒ€ãƒ ä½ç½®ï¼‰
    for (let i = 0; i < 3; i++) {
      setTimeout(() => {
        const heart = document.createElement('div');
        heart.className = 'heart-effect';
        heart.textContent = ['â¤ï¸', 'ğŸ’–', 'ğŸ’•'][i];

        const rect = element.getBoundingClientRect();
        heart.style.left = rect.left + (Math.random() * rect.width) + 'px';
        heart.style.top = rect.top + (Math.random() * rect.height) + 'px';

        document.body.appendChild(heart);
        setTimeout(() => heart.remove(), 1000);
      }, i * 100);
    }
  }

  // Instagramé¢¨ã„ã„ã­é€šçŸ¥ã‚’è¡¨ç¤º
  function showLikeNotification(type) {
    const notification = document.getElementById('like-notification');
    const content = document.getElementById('like-notification-content');

    // æ—¢å­˜ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
    notification.classList.remove('show');
    content.classList.remove('unlike');

    if (type === 'like') {
      content.textContent = 'â¤ï¸';
      content.classList.remove('unlike');
    } else if (type === 'unlike') {
      content.textContent = 'ğŸ¤';
      content.classList.add('unlike');
    }

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†ãƒˆãƒªã‚¬ãƒ¼
    setTimeout(() => {
      notification.classList.add('show');
    }, 10);

    // 0.5ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
    setTimeout(() => {
      notification.classList.remove('show');
    }, 500);
  }

  // toggleLikeé–¢æ•°ã‚’æ‹¡å¼µï¼ˆInstagramé¢¨é€šçŸ¥è¿½åŠ ï¼‰
  const originalToggleLike = toggleLike;
  toggleLike = async function() {
    const currentFile = fileList[idx];
    if (!currentFile || !currentFile.id) return;

    const photoId = currentFile.id;
    const wasLiked = likedImages.has(photoId);

    // å…ƒã®é–¢æ•°ã‚’å®Ÿè¡Œ
    await originalToggleLike.call(this);

    // ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèª
    const isNowLiked = likedImages.has(photoId);

    if (!wasLiked && isNowLiked) {
      // ã„ã„ã­è¿½åŠ æ™‚
      const likeBtn = document.getElementById('like-btn');
      createEnhancedLikeEffect(likeBtn);
      showLikeNotification('like');

      // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’ã€Œè§£é™¤ã€ã«å¤‰æ›´
      likeBtn.setAttribute('data-tooltip', 'è§£é™¤');
    } else if (wasLiked && !isNowLiked) {
      // ã„ã„ã­è§£é™¤æ™‚
      showLikeNotification('unlike');

      // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’ã€Œã„ã„ã­ã€ã«å¤‰æ›´
      const likeBtn = document.getElementById('like-btn');
      likeBtn.setAttribute('data-tooltip', 'ã„ã„ã­');
    }
  };

  // Supabase Realtimeã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
  let supabaseClient = null;
  let realtimeChannel = null;

  async function initRealtimeUpdates() {
    try {
      // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–ï¼ˆç’°å¢ƒå¤‰æ•°ã¯ä½¿ãˆãªã„ã®ã§ã€å…¬é–‹ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰
      // æ³¨: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã¯ç’°å¢ƒå¤‰æ•°ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ãŸã‚ã€
      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã¯5ç§’ã”ã¨ã®ãƒãƒ¼ãƒªãƒ³ã‚°ã§ä»£æ›¿

      startPollingForUpdates();
    } catch (error) {
      console.log('Realtime updates not available, using polling instead');
      startPollingForUpdates();
    }
  }

  // ãƒãƒ¼ãƒªãƒ³ã‚°ã§ã„ã„ã­æ•°ã®å¤‰æ›´ã‚’æ¤œå‡º
  let lastKnownCounts = {};
  let pollingInterval = null;

  function startPollingForUpdates() {
    // 5ç§’ã”ã¨ã«ç¾åœ¨ã®å†™çœŸã®ã„ã„ã­æ•°ã‚’ãƒã‚§ãƒƒã‚¯
    pollingInterval = setInterval(async () => {
      if (slides.length === 0 || !fileList[idx]) return;

      const currentFile = fileList[idx];
      if (!currentFile || !currentFile.id) return;

      try {
        const response = await fetch(`/api/like?photoId=${currentFile.id}`);
        const result = await response.json();

        if (result.success) {
          const newCount = result.count || 0;
          const oldCount = lastKnownCounts[currentFile.id] || 0;

          // ã„ã„ã­æ•°ãŒå¢—ãˆãŸå ´åˆã«é€šçŸ¥
          if (oldCount > 0 && newCount > oldCount) {
            showRealtimeNotification(`èª°ã‹ãŒã“ã®å†™çœŸã«ã„ã„ã­ã—ã¾ã—ãŸï¼ (+${newCount - oldCount})`);

            // ã„ã„ã­æ•°ã‚’æ›´æ–°
            imageLikeCounts[idx] = newCount;
            updateLikeButton();
          }

          lastKnownCounts[currentFile.id] = newCount;
        }
      } catch (error) {
        // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ‡æ–­æ™‚ãªã©ï¼‰
      }
    }, 5000); // 5ç§’ã”ã¨
  }

  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ã‚’è¡¨ç¤º
  function showRealtimeNotification(message) {
    const notify = document.getElementById('realtime-notify');
    const messageEl = document.getElementById('realtime-message');

    messageEl.textContent = message;
    notify.classList.add('show');

    setTimeout(() => {
      notify.classList.remove('show');
    }, 3000);
  }

  // UIéè¡¨ç¤ºæ™‚ã‚‚çµ±è¨ˆãƒœã‚¿ãƒ³ã¯éè¡¨ç¤ºã«ã™ã‚‹
  const originalHideUI = hideUI;
  hideUI = function() {
    originalHideUI();
    document.getElementById('stats-btn').classList.add('hidden');
  };

  const originalShowUI = showUI;
  showUI = function() {
    originalShowUI();
    document.getElementById('stats-btn').classList.remove('hidden');
  };

  // åˆæœŸåŒ–
  initOpening();
  initBGM();
  init();
  initRealtimeUpdates();
  </script>
</body>
</html>
