<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tarobo Faces - Random 30 Slideshow</title>
  <style>
    :root { --fade-ms: 1200; --show-ms: 2500; }
    html,body,#stage{height:100%;margin:0;background:#000}
    #stage{position:relative;overflow:hidden;touch-action:none}
    .slide{
      position:absolute; inset:0;
      width:100%; height:100%; object-fit:cover;
      opacity:0;
      transition:opacity 1200ms ease-in-out;
      will-change: opacity;
    }
    .slide.active{opacity:1}
    #hud{
      position:fixed; left:12px; bottom:12px; z-index:25;
      color:#fff; font:12px/1.4 system-ui,-apple-system,Segoe UI,Roboto;
      background:rgba(0,0,0,.35); padding:8px 10px; border-radius:10px;
      backdrop-filter: blur(6px);
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      max-width:calc(100vw - 200px);
      transition: bottom 0.3s ease, opacity 0.3s ease, transform 0.3s ease;
      opacity: 1;
      transform: translateY(0);
    }
    #hud.hidden{
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
    }
    #hud.raised{
      bottom:152px; /* サムネイル高さ140px + 余白12px */
    }
    button{border:1px solid #666; background:#111; color:#fff; padding:6px 10px; border-radius:8px; cursor:pointer; margin:0}
    button:hover{background:#333; border-color:#888}
    button:active{background:#000}
    button.active{background:#0066cc; border-color:#0066cc}
    a{color:#8bdcff}

    /* 画像情報表示 */
    #image-info{
      position:fixed; top:12px; right:12px; z-index:10;
      color:#fff; font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto;
      background:rgba(0,0,0,.35); padding:10px 14px; border-radius:10px;
      backdrop-filter: blur(6px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      opacity: 1;
      transform: translateY(0);
    }
    #image-info.hidden{
      opacity: 0;
      transform: translateY(-20px);
      pointer-events: none;
    }
    #counter{font-size:20px; font-weight:bold; margin-bottom:4px}
    #filename{font-size:12px; opacity:0.8; max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}

    /* 進捗バー */
    #progress-bar{
      position:fixed; top:0; left:0; right:0; height:3px; z-index:20;
      background:rgba(255,255,255,0.1);
    }
    #progress-fill{
      height:100%; width:0%; background:linear-gradient(90deg, #0066cc, #00ccff);
      transition:width 100ms linear;
    }

    /* スピードコントロールは削除済み */

    /* Aboutボタン */
    #about-btn{
      position:fixed; top:12px; left:12px; z-index:10;
      width:60px; height:60px; border-radius:10px;
      background:rgba(0,0,0,0.35); border:1px solid #666;
      color:#fff; font-size:24px; cursor:pointer;
      backdrop-filter: blur(6px);
      transition: all 0.3s ease, opacity 0.3s ease, transform 0.3s ease;
      display:flex; align-items:center; justify-content:center;
      opacity: 1;
    }
    #about-btn.hidden{
      opacity: 0;
      transform: translateY(-20px);
      pointer-events: none;
    }
    #about-btn:hover{
      transform:scale(1.05);
      background:rgba(0,0,0,0.5);
      border-color:#888;
    }
    #about-panel{
      position:fixed; top:60px; left:60px; z-index:10;
      color:#fff; font:12px/1.6 system-ui,-apple-system,Segoe UI,Roboto;
      background:rgba(0,0,0,0.85); padding:12px 16px; border-radius:10px;
      backdrop-filter: blur(10px);
      border:1px solid #666;
      max-width:360px;
      display:none;
    }
    #about-panel.show{ display:block; }
    #about-panel h3{
      margin:0 0 12px 0; font-size:14px; font-weight:bold;
    }
    #about-panel p{
      margin:8px 0;
      line-height:1.6;
    }
    #about-panel .tagline{
      font-size:11px;
      color:#999;
      margin-top:12px;
      padding-top:8px;
      border-top:1px solid #444;
    }


    /* オープニング画面 */
    #opening{
      position:fixed; inset:0; z-index:200;
      background:#000;
      display:flex; align-items:center; justify-content:center;
      opacity:1;
      transition:opacity 0.8s ease;
    }
    #opening.hide{ opacity:0; pointer-events:none; }
    #opening-content{
      text-align:center; color:#fff;
      max-width:600px; padding:40px;
    }
    #opening-logo{
      width:120px; height:auto;
      margin:0 auto 24px auto;
      display:block;
      opacity:0.9;
    }
    #opening h1{
      font-size:28px; font-weight:bold; margin:0 auto 16px auto;
      line-height:1.6;
      text-align:center;
      width:100%;
    }
    #opening .sub{
      font-size:16px; color:#999; margin:0 0 32px 0;
    }
    #opening .tagline{
      font-size:14px; margin:32px 0;
      padding:16px 0; border-top:1px solid #333; border-bottom:1px solid #333;
    }
    #opening-start{
      background:rgba(255,255,255,0.1); border:1px solid #666;
      color:#fff; padding:12px 32px; border-radius:8px;
      font-size:16px; cursor:pointer;
      transition:all 0.3s;
      margin-top:24px;
    }
    #opening-start:hover{
      background:rgba(255,255,255,0.2); border-color:#888;
      transform:scale(1.05);
    }
    #opening-skip{
      background:transparent; border:none;
      color:#666; padding:8px; margin-top:16px;
      font-size:12px; cursor:pointer;
    }
    #opening-skip:hover{ color:#999; }

    /* いいねボタン */
    #like-btn{
      position:fixed; right:12px; bottom:80px; z-index:15;
      width:60px; height:60px; border-radius:10px;
      background:rgba(0,0,0,0.35); border:1px solid #666;
      color:#fff; font-size:28px; cursor:pointer;
      backdrop-filter: blur(6px);
      transition: all 0.3s ease, opacity 0.3s ease, transform 0.3s ease, bottom 0.3s ease;
      opacity: 1;
    }
    #like-btn.raised{
      bottom:220px; /* サムネイル高さ140px + HUD余白12px + 元のbottom 80px - 12px調整 */
    }
    #like-btn.hidden{
      opacity: 0;
      transform: translateX(20px);
      pointer-events: none;
    }
    #like-btn:hover{
      transform:scale(1.05);
      background:rgba(0,0,0,0.5);
      border-color:#888;
    }
    #like-btn:active{ transform:scale(0.95); }
    #like-btn.liked{ animation: heartBeat 0.6s ease; }
    @keyframes heartBeat {
      0% { transform: scale(1); }
      15% { transform: scale(1.3); }
      30% { transform: scale(1.1); }
      45% { transform: scale(1.25); }
      60% { transform: scale(1.1); }
      75% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }
    #like-count{
      position:absolute; top:-8px; right:-8px;
      background:rgba(255,50,50,0.95); color:#fff; font-size:13px; font-weight:bold;
      padding:3px 7px; border-radius:12px; min-width:22px; text-align:center;
      border:2px solid rgba(255,255,255,0.4);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    }

    /* SNSシェアボタン */
    #share-btns{
      position:fixed; right:12px; bottom:150px; z-index:15;
      display:flex; flex-direction:column; gap:6px;
      transition: opacity 0.3s ease, transform 0.3s ease, bottom 0.3s ease;
      opacity: 1;
    }
    #share-btns.raised{
      bottom:290px; /* サムネイル高さ140px + 元のbottom 150px */
    }
    #share-btns.hidden{
      opacity: 0;
      transform: translateX(20px);
      pointer-events: none;
    }
    .share-btn{
      width:60px; height:60px; border-radius:10px;
      border:1px solid #666; cursor:pointer; font-size:20px;
      transition: all 0.3s ease;
      background:rgba(0,0,0,0.35);
      color:#fff;
      backdrop-filter: blur(6px);
      display:flex; align-items:center; justify-content:center;
    }
    .share-btn:hover{
      transform:scale(1.05);
      background:rgba(0,0,0,0.5);
      border-color:#888;
    }
    .share-btn:active{ transform:scale(0.95); }

    /* モーダル（画像拡大表示） */
    #modal{
      display:none; position:fixed; inset:0; z-index:100;
      background:rgba(0,0,0,0.95); cursor:zoom-out;
      align-items:center; justify-content:center;
    }
    #modal.show{ display:flex; }
    #modal img{
      max-width:90%; max-height:90%; object-fit:contain;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    #modal-close{
      position:absolute; top:20px; right:20px;
      background:rgba(255,255,255,0.2); border:none;
      color:#fff; font-size:30px; width:50px; height:50px;
      border-radius:50%; cursor:pointer;
      backdrop-filter: blur(6px);
    }
    #modal-close:hover{ background:rgba(255,255,255,0.3); }

    /* モーダル内のいいねボタン */
    #modal-like-btn{
      position:absolute; bottom:20px; right:20px;
      width:60px; height:60px; border-radius:10px;
      background:rgba(0,0,0,0.5); border:1px solid #666;
      color:#fff; font-size:30px; cursor:pointer;
      backdrop-filter: blur(6px);
      transition: all 0.3s ease;
      display:flex; align-items:center; justify-content:center;
    }
    #modal-like-btn:hover{
      transform:scale(1.05);
      background:rgba(0,0,0,0.7);
      border-color:#888;
    }
    #modal-like-btn.liked{
      animation: heartBeat 0.6s ease;
    }

    /* エフェクト選択 */
    /* エフェクトセレクターは削除済み */

    /* BGMコントロール */
    #bgm-controls{
      display:flex; gap:6px; align-items:center;
    }
    #bgm-toggle{
      background:#111; border:1px solid #666;
      color:#fff; padding:6px 10px; border-radius:8px; cursor:pointer;
      white-space:nowrap;
    }
    #bgm-toggle.playing{ background:#0066cc; border-color:#0066cc; }
    #bgm-volume{
      width:60px;
    }

    /* スライドエフェクト用 */
    .slide.effect-slide-left{
      transform:translateX(-100%);
      transition:opacity var(--fade-ms)ms linear, transform var(--fade-ms)ms ease-out;
    }
    .slide.effect-slide-left.active{ transform:translateX(0); }

    .slide.effect-slide-right{
      transform:translateX(100%);
      transition:opacity var(--fade-ms)ms linear, transform var(--fade-ms)ms ease-out;
    }
    .slide.effect-slide-right.active{ transform:translateX(0); }

    .slide.effect-zoom{
      transform:scale(0.8);
      transition:opacity var(--fade-ms)ms linear, transform var(--fade-ms)ms ease-out;
    }
    .slide.effect-zoom.active{ transform:scale(1); }

    .slide.effect-rotate{
      transform:rotate(-5deg) scale(0.9);
      transition:opacity var(--fade-ms)ms linear, transform var(--fade-ms)ms ease-out;
    }
    .slide.effect-rotate.active{ transform:rotate(0deg) scale(1); }

    /* サムネイル一覧 */
    #thumbnails-container{
      position:fixed; bottom:0; left:0; right:0; height:0; z-index:20;
      background:rgba(0,0,0,0.9); backdrop-filter:blur(10px);
      transition:height 0.3s ease;
      overflow:hidden;
    }
    #thumbnails-container.show{ height:140px; }
    #thumbnails-wrapper{
      display:flex; gap:8px; padding:12px;
      overflow-x:auto; overflow-y:hidden; height:100%;
      align-items:center;
    }
    #thumbnails-wrapper::-webkit-scrollbar{ height:8px; }
    #thumbnails-wrapper::-webkit-scrollbar-track{ background:rgba(255,255,255,0.1); }
    #thumbnails-wrapper::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,0.3); border-radius:4px;
    }
    .thumbnail{
      flex-shrink:0; width:100px; height:100px;
      object-fit:cover; border-radius:8px; cursor:pointer;
      border:2px solid transparent; transition:all 0.2s ease;
      position:relative;
    }
    .thumbnail:hover{
      transform:scale(1.1); border-color:#888;
    }
    .thumbnail.active{
      border-color:#0066cc; box-shadow:0 0 12px rgba(0,102,204,0.6);
    }
    .thumbnail.liked::after{
      content:'🤍'; position:absolute; top:4px; right:4px;
      font-size:16px; text-shadow:0 0 4px rgba(0,0,0,0.8);
    }

    /* フィルターボタン */
    #filter-controls{
      position:fixed; top:50%; right:12px; transform:translateY(-50%); z-index:15;
      display:flex; flex-direction:column; gap:6px;
      transition: opacity 0.3s ease, transform 0.3s ease;
      opacity: 1;
    }
    #filter-controls.hidden{
      opacity: 0;
      transform: translateY(-50%) translateX(20px);
      pointer-events: none;
    }
    #filter-all, #filter-liked{
      width:60px; height:60px; border-radius:10px;
      border:1px solid #666; cursor:pointer;
      background:rgba(0,0,0,0.35); color:#fff;
      backdrop-filter:blur(6px); transition:all 0.3s ease;
      display:flex; align-items:center; justify-content:center;
      font-size:24px;
    }
    #filter-all:hover, #filter-liked:hover{
      transform:scale(1.05); background:rgba(0,0,0,0.5); border-color:#888;
    }
    #filter-all.active, #filter-liked.active{
      background:#0066cc; border-color:#0066cc;
    }

    /* 統計情報パネル */
    #stats-btn{
      position:fixed; top:12px; left:80px; z-index:10;
      width:60px; height:60px; border-radius:10px;
      background:rgba(0,0,0,0.35); border:1px solid #666;
      color:#fff; font-size:24px; cursor:pointer;
      backdrop-filter: blur(6px);
      transition: all 0.3s ease, opacity 0.3s ease, transform 0.3s ease;
      display:flex; align-items:center; justify-content:center;
      opacity: 1;
    }
    #stats-btn.hidden{
      opacity: 0;
      transform: translateY(-20px);
      pointer-events: none;
    }
    #stats-btn:hover{
      transform:scale(1.05);
      background:rgba(0,0,0,0.5);
      border-color:#888;
    }
    #stats-panel{
      position:fixed; top:60px; left:128px; z-index:10;
      color:#fff; font:12px/1.6 system-ui,-apple-system,Segoe UI,Roboto;
      background:rgba(0,0,0,0.85); padding:12px 16px; border-radius:10px;
      backdrop-filter: blur(10px);
      border:1px solid #666;
      max-width:320px;
      display:none;
      min-width:280px;
    }
    #stats-panel.show{ display:block; }
    #stats-panel h3{
      margin:0 0 12px 0; font-size:14px; font-weight:bold;
    }
    #stats-panel .stat-item{
      display:flex; justify-content:space-between; align-items:center;
      margin:8px 0; padding:10px 12px;
      background:rgba(255,255,255,0.05);
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.1);
    }
    #stats-panel .stat-label{
      color:#aaa; font-size:12px; font-weight:500;
    }
    #stats-panel .stat-value{
      color:#00ccff; font-size:24px; font-weight:bold;
    }
    #stats-panel .ranking-list{
      margin:12px 0 0 0; padding:0; list-style:none;
      max-height:300px; overflow-y:auto;
    }
    #stats-panel .ranking-item{
      display:flex; align-items:center; gap:8px;
      margin:6px 0; padding:8px 10px; background:rgba(255,255,255,0.05);
      border-radius:6px; cursor:pointer;
      transition:all 0.2s;
      border:1px solid rgba(255,255,255,0.1);
    }
    #stats-panel .ranking-item:hover{
      background:rgba(0,102,204,0.2); transform:translateX(4px);
      border-color:rgba(0,102,204,0.5);
    }
    #stats-panel .ranking-item:active{
      transform:translateX(2px) scale(0.98);
    }
    #stats-panel .ranking-rank{
      font-size:16px; font-weight:bold; color:#0066cc; min-width:24px;
    }
    #stats-panel .ranking-count{
      margin-left:auto; color:#ff6b6b; font-weight:bold;
    }
    #stats-panel .loading{
      text-align:center; padding:20px; color:#666;
    }

    /* いいねエフェクト強化 */
    @keyframes heartPop {
      0% { transform: scale(1); }
      20% { transform: scale(1.4) rotate(-5deg); }
      40% { transform: scale(1.2) rotate(5deg); }
      60% { transform: scale(1.3) rotate(-3deg); }
      80% { transform: scale(1.15) rotate(2deg); }
      100% { transform: scale(1) rotate(0deg); }
    }
    @keyframes heartFloat {
      0% { opacity: 1; transform: translateY(0) scale(0.5); }
      50% { opacity: 0.8; transform: translateY(-30px) scale(1); }
      100% { opacity: 0; transform: translateY(-60px) scale(0.8); }
    }
    @keyframes ripple {
      0% { transform: scale(0.8); opacity: 1; }
      100% { transform: scale(2.5); opacity: 0; }
    }
    .heart-effect{
      position:fixed; font-size:40px; pointer-events:none;
      animation: heartFloat 1s ease-out forwards;
      z-index:1000;
    }
    .ripple-effect{
      position:absolute; inset:0; border-radius:10px;
      border:3px solid rgba(255,50,50,0.6);
      animation: ripple 0.6s ease-out;
      pointer-events:none;
    }

    /* Instagram風いいね通知 */
    #like-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 200;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    #like-notification.show {
      opacity: 1;
    }
    #like-notification-content {
      font-size: 64px;
      text-align: center;
      animation: likePopup 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      filter: drop-shadow(0 4px 20px rgba(0,0,0,0.4));
    }
    #like-notification-content.unlike {
      font-size: 48px;
      opacity: 0.7;
    }
    @keyframes likePopup {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* サムネイル上のいいね解除ボタン */
    .thumbnail-container {
      position: relative;
      display: inline-block;
    }
    .thumbnail-like-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 36px;
      height: 36px;
      background: rgba(0,0,0,0.75);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s ease;
      z-index: 10;
      backdrop-filter: blur(4px);
    }
    .thumbnail-like-btn:hover {
      transform: scale(1.15);
      background: rgba(255,50,50,0.9);
      border-color: rgba(255,255,255,0.6);
    }
    .thumbnail-like-btn:active {
      transform: scale(0.95);
    }

    /* いいねボタンのツールチップ（PC用） */
    #like-btn::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }
    #like-btn:hover::after {
      opacity: 1;
    }
    @media (max-width: 768px) {
      #like-btn::after {
        display: none; /* モバイルではツールチップ非表示 */
      }
    }

    /* リアルタイム通知 */
    #realtime-notify{
      position:fixed; top:80px; right:12px; z-index:100;
      background:rgba(255,50,50,0.95); color:#fff;
      padding:12px 16px; border-radius:8px;
      font:12px/1.4 system-ui,-apple-system,Segoe UI,Roboto;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
      transform:translateX(400px);
      transition:transform 0.3s ease;
      max-width:280px;
    }
    #realtime-notify.show{
      transform:translateX(0);
    }
    #realtime-notify .notify-icon{
      display:inline-block; margin-right:8px; font-size:16px;
    }

    /* スマホ対応 */
    @media (max-width: 768px) {
      /* HUD（ボタン群）を小さく */
      #hud{
        font-size:10px;
        padding:6px 8px;
        gap:4px;
        max-width:calc(100vw - 24px);
        left:6px;
        bottom:6px;
      }
      #hud.raised{
        bottom:126px; /* サムネイル高さを調整 */
      }

      /* ボタンを小さく */
      button{
        padding:4px 8px;
        font-size:11px;
        border-radius:6px;
      }
      /* スピードコントロールは削除済み */

      /* 画像情報を小さく */
      #image-info{
        top:6px;
        right:6px;
        padding:6px 10px;
        font-size:12px;
      }
      #counter{
        font-size:16px;
      }
      #filename{
        font-size:10px;
        max-width:150px;
      }

      /* Aboutボタン */
      #about-btn{
        top:6px;
        left:6px;
        width:50px;
        height:50px;
        font-size:20px;
      }

      /* 統計ボタン */
      #stats-btn{
        top:6px;
        left:62px;
        width:50px;
        height:50px;
        font-size:20px;
      }

      /* 統計パネル */
      #stats-panel{
        top:62px;
        left:6px;
        right:6px;
        max-width:none;
        min-width:0;
        width:calc(100vw - 12px);
        max-height:calc(100vh - 80px);
        overflow-y:auto;
        font-size:11px;
        padding:10px 12px;
      }

      /* サムネイル表示を小さく */
      #thumbnail-container{
        height:100px;
      }
      #thumbnail-list{
        height:100px;
      }
      .thumbnail{
        width:70px;
        height:70px;
      }

      /* 右側ボタン群の配置を再計算 */
      /* HUDは2行に折り返す可能性があり、高さ約80-100px */

      /* いいねボタン（一番下） */
      #like-btn{
        width:50px;
        height:50px;
        font-size:24px;
        bottom:110px; /* HUD分の余裕を持たせる */
        right:6px;
      }
      #like-btn.raised{
        bottom:250px; /* サムネイル高さ140px + HUD余白12px + 元のbottom 110px - 12px調整 */
      }

      /* SNSシェアボタン（いいねの上、3つ縦に並ぶ: 50px×3 + gap 6px×2 = 162px） */
      #share-btns{
        bottom:166px; /* 110px(いいねbottom) + 50px(いいねheight) + 6px(gap) */
        right:6px;
      }
      #share-btns.raised{
        bottom:306px; /* サムネイル高さ140px + 元のbottom 166px */
      }
      .share-btn{
        width:50px;
        height:50px;
        font-size:18px;
      }

      /* フィルターボタン（中央ではなく、SNSボタンの上に配置） */
      #filter-controls{
        top:auto;
        bottom:334px; /* 166px(SNSbottom) + 162px(SNS全体height) + 6px(gap) */
        transform:none;
        right:6px;
      }
      #filter-all, #filter-liked{
        width:50px;
        height:50px;
        font-size:20px;
      }

      /* オープニング画面 */
      #opening-logo{
        max-width:200px;
      }
      #opening h1{
        font-size:20px;
      }
      #opening .sub{
        font-size:12px;
      }
      #opening .tagline{
        font-size:11px;
      }
    }
  </style>
</head>
<body>
  <!-- Config file is no longer needed - using Vercel API instead -->

  <div id="progress-bar"><div id="progress-fill"></div></div>
  <div id="stage" aria-label="スライドショー領域"></div>

  <!-- オープニング画面 -->
  <div id="opening">
    <div id="opening-content">
      <img src="tarobo-logo-white.png" alt="TAROBO CHALLENGE" id="opening-logo">
      <h1>歴史を駆け抜け、未来を掴め</h1>
      <p class="sub">掴んだ手すりに残るのは、己の汗と挑戦し続ける意思</p>
      <p class="tagline">太郎坊チャレンジ 2025<br>掴む、その瞬間の記録</p>
      <button id="opening-start" title="スライドショーを開始します">スライドショーを見る →</button>
      <br>
      <button id="opening-skip" title="オープニングをスキップしてすぐに開始します">Skip</button>
    </div>
  </div>

  <!-- Aboutボタン -->
  <button id="about-btn" title="このプロジェクトについて">ⓘ</button>
  <div id="about-panel">
    <h3>About this project</h3>
    <p>太郎坊チャレンジのスローガンは<br>「<strong>歴史を駆け抜け、未来を掴め！</strong>」</p>
    <p>379段の石段を駆け上がる参加者一人ひとりの"あと30mの表情"を記録しました。</p>
    <p>写っているのは、ただの顔ではなく、限界を超える瞬間の意思です。</p>
    <p>撮影は一人のカメラマンが、マニュアルフォーカスで一日中追い続けました。すべてのチャレンジャーを撮り切れたわけではありませんが、写らなかった人の挑戦も、私たちの記憶の中に確かに刻まれています。</p>
    <p>このスライドショーは、膨大なアーカイブからランダムに選ばれた50枚を表示します。ページをリロード、または🔄ボタンを押すたび、新たな50の表情と出会えます。</p>
    <p class="tagline">これは、未来を掴もうとした全ての人の記録です。</p>
  </div>

  <!-- 統計情報ボタン -->
  <button id="stats-btn" title="いいね統計情報を表示">📊</button>
  <div id="stats-panel">
    <h3>📊 いいね統計</h3>
    <div id="stats-summary">
      <div class="stat-item">
        <span class="stat-label">総いいね数</span>
        <span class="stat-value" id="stat-total">-</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">人気写真数</span>
        <span class="stat-value" id="stat-photos">-</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">ユーザー数</span>
        <span class="stat-value" id="stat-users">-</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">平均いいね数</span>
        <span class="stat-value" id="stat-avg">-</span>
      </div>
    </div>
    <a href="ranking.html" target="_blank" style="display:block; margin-top:20px; padding:14px 16px; background:linear-gradient(135deg, rgba(0,102,204,0.3), rgba(0,204,255,0.3)); border:2px solid rgba(0,102,204,0.6); border-radius:12px; color:#fff; text-decoration:none; text-align:center; transition:all 0.3s; font-weight:bold; font-size:14px;">
      🏆 人気ランキング TOP10を見る →
    </a>
  </div>

  <!-- リアルタイム通知 -->
  <div id="realtime-notify">
    <span class="notify-icon">❤️</span>
    <span id="realtime-message">誰かがいいねしました！</span>
  </div>

  <div id="image-info">
    <div id="counter">-/-</div>
    <div id="filename">-</div>
  </div>

  <!-- フィルターボタン -->
  <div id="filter-controls">
    <button id="filter-all" class="active" title="全ての写真を表示します">📷</button>
    <button id="filter-liked" title="いいねした写真だけを表示します">🤍</button>
  </div>

  <!-- いいねボタン -->
  <button id="like-btn" title="この写真にいいね！（Lキー）" data-tooltip="いいね">
    🩶
    <span id="like-count">0</span>
  </button>

  <!-- Instagram風いいね通知 -->
  <div id="like-notification">
    <div id="like-notification-content"></div>
  </div>

  <!-- SNSシェアボタン -->
  <div id="share-btns">
    <button class="share-btn" id="share-twitter" title="この写真をTwitterでシェア">𝕏</button>
    <button class="share-btn" id="share-facebook" title="この写真をFacebookでシェア">f</button>
    <button class="share-btn" id="share-line" title="この写真をLINEでシェア">L</button>
  </div>

  <!-- サムネイル一覧 -->
  <div id="thumbnails-container">
    <div id="thumbnails-wrapper"></div>
  </div>

  <!-- モーダル（画像拡大） -->
  <div id="modal">
    <button id="modal-close">×</button>
    <button id="modal-like-btn">🤍</button>
    <img id="modal-img" src="" alt="拡大画像">
  </div>

  <div id="hud">
    <div id="bgm-controls">
      <button id="bgm-toggle" title="BGMをON/OFFします">🎵 BGM</button>
      <input type="range" id="bgm-volume" min="0" max="100" value="50" title="BGMの音量を調整します">
    </div>
    <button id="thumbnails-toggle" title="全ての写真を一覧表示します（Tキー）">📸 写真一覧</button>
    <span id="info">source=1146 / showing=50</span>
  </div>

  <!-- BGM用のオーディオ要素 -->
  <audio id="bgm-audio" loop>
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
  </audio>

  <script>
  // ===== 設定 =====
  // Vercel Functions経由でGoogle Drive APIにアクセスします
  // 環境変数はVercelの設定で管理されます

  const COUNT = 50;     // 表示枚数
  const FADE_MS = 1200;  // フェード時間
  const PRELOAD_COUNT = 2;

  // スピード設定
  const SPEEDS = {
    slow: 6000,
    normal: 3500,
    fast: 1500
  };

  let SHOW_MS = SPEEDS.normal;
  let currentSpeed = 'normal';

  document.documentElement.style.setProperty('--fade-ms', FADE_MS);
  document.documentElement.style.setProperty('--show-ms', SHOW_MS);

  let slides = [], idx = 0, timer = null, running = false, progressTimer = null;
  let fileList = []; // ファイル名保存用
  let currentEffect = 'fade'; // 現在のエフェクト
  let likedImages = new Set(); // いいねした画像のphotoId（Google Drive ID）
  let imageLikeCounts = {}; // 各画像のいいね数を保存 {photoId: count}
  let bgmAudio = null; // BGMオーディオ要素
  let allSlides = []; // 全スライドのバックアップ
  let allPhotosData = []; // 全画像データ（1146枚）を保存 {id, name, url}
  let currentFilter = 'all'; // 現在のフィルター状態
  let thumbnailsVisible = false; // サムネイル表示状態

  // Vercel Functions経由で画像リストを取得
  // キャッシュにより、429エラーを防ぎます
  async function fetchList(){
    try {
      // Vercel FunctionsのAPIエンドポイントを呼び出す
      const apiUrl = '/api/photos';

      console.log('Fetching photos from API...');

      const res = await fetch(apiUrl);
      if (!res.ok) {
        throw new Error(`API Error: ${res.status} ${res.statusText}`);
      }

      const result = await res.json();

      if (!result.success) {
        throw new Error(result.error || 'Unknown error');
      }

      // 全画像リストを取得してランダムに50枚選択
      const allPhotos = result.files;

      // 全画像データをグローバルに保存（いいねフィルタ用）
      allPhotosData = allPhotos.map(f => ({
        id: f.id,
        name: f.name,
        url: `https://drive.google.com/thumbnail?id=${f.id}&sz=w1200`
      }));

      const shuffled = [...allPhotos].sort(() => Math.random() - 0.5);
      const picked = shuffled.slice(0, COUNT);

      console.log(`✅ Loaded ${result.total} total images, randomly picked ${picked.length} photos`);
      if (result.cached) {
        console.log(`📦 Cache age: ${result.cacheAge} seconds`);
      }

      return {
        all: result.total,
        pick: picked
      };

    } catch (error) {
      console.error('Failed to fetch photos:', error);

      // フォールバック: 直接Google Drive APIを呼び出す（後方互換性のため）
      console.log('Falling back to direct Google Drive API...');
      return fetchListDirect();
    }
  }

  // フォールバック用: 直接Google Drive APIを呼び出す（config.jsが必要）
  async function fetchListDirect(){
    if (typeof CONFIG === 'undefined' || !CONFIG.API_KEY) {
      throw new Error('APIキーが設定されていません。config.jsを確認してください。');
    }

    let allFiles = [];
    let pageToken = null;

    do {
      const params = {
        q: `'${CONFIG.FOLDER_ID}' in parents and (mimeType contains 'image/')`,
        key: CONFIG.API_KEY,
        fields: 'files(id,name,mimeType,webContentLink),nextPageToken',
        pageSize: '1000',
        orderBy: 'name'
      };

      if (pageToken) {
        params.pageToken = pageToken;
      }

      const url = `https://www.googleapis.com/drive/v3/files?` + new URLSearchParams(params);

      const res = await fetch(url);
      if (!res.ok) {
        const error = await res.json();
        throw new Error(`API Error: ${error.error?.message || 'Unknown error'}`);
      }

      const data = await res.json();
      allFiles = allFiles.concat(data.files || []);
      pageToken = data.nextPageToken;

    } while (pageToken);

    const shuffled = allFiles.sort(() => Math.random() - 0.5);
    const pick = shuffled.slice(0, COUNT).map(f => ({
      url: `https://drive.google.com/thumbnail?id=${f.id}&sz=w1200`,
      name: f.name,
      id: f.id
    }));

    return { all: allFiles.length, pick };
  }

  function createSlides(list){
    const stage = document.getElementById('stage');
    stage.innerHTML = '';
    slides = [];
    fileList = list; // ファイル情報を保存
    let added = 0;
    list.forEach((f, i) => {
      if (added >= COUNT) return;
      const img = document.createElement('img');
      img.src = f.url;
      img.alt = f.name || `photo-${i+1}`;
      img.className = 'slide';
      img.dataset.index = i; // 配列内インデックスを保存
      img.dataset.photoId = f.id; // Google Drive IDを保存
      if (i >= PRELOAD_COUNT) img.loading = 'lazy';
      img.onerror = () => { img.remove(); }; // 403等は除去
      img.onload = () => { added++; };       // 読めたものだけカウント
      stage.appendChild(img);
      slides.push(img);
    });
    allSlides = [...slides]; // 全スライドを保存
    createThumbnails(list); // サムネイルを生成
  }

  // サムネイル一覧を生成
  function createThumbnails(list){
    const wrapper = document.getElementById('thumbnails-wrapper');
    wrapper.innerHTML = '';

    // いいねフィルタ中かどうかをチェック
    const isLikedFilter = currentFilter === 'liked';

    // listがスライド要素の配列の場合と、ファイル情報の配列の場合がある
    list.forEach((f, i) => {
      // サムネイルコンテナ（いいねボタンを配置するため）
      const container = document.createElement('div');
      container.className = 'thumbnail-container';

      const thumb = document.createElement('img');

      // スライド要素の場合
      if (f instanceof HTMLImageElement) {
        thumb.src = f.src;
        thumb.alt = f.alt;
        thumb.dataset.index = i;
        thumb.dataset.photoId = f.dataset.photoId;

        // photoIdでいいね状態をチェック
        if (likedImages.has(f.dataset.photoId)) {
          thumb.classList.add('liked');
        }
      } else {
        // ファイル情報の場合（初回読み込み時）
        thumb.src = f.url;
        thumb.alt = f.name || `thumb-${i+1}`;
        thumb.dataset.index = i;
        thumb.dataset.photoId = f.id;

        if (likedImages.has(f.id)) {
          thumb.classList.add('liked');
        }
      }

      thumb.className = 'thumbnail';

      // クリックで該当画像にジャンプ
      thumb.onclick = () => jumpToSlide(i);

      container.appendChild(thumb);

      // いいねフィルタ中の場合、❤️解除ボタンを追加
      if (isLikedFilter) {
        const likeBtn = document.createElement('button');
        likeBtn.className = 'thumbnail-like-btn';
        likeBtn.innerHTML = '❤️';
        likeBtn.title = 'いいね解除';

        likeBtn.onclick = async (e) => {
          e.stopPropagation(); // サムネイルクリックと干渉しないように

          const photoId = thumb.dataset.photoId;
          if (!photoId) return;

          // いいね解除
          await removeLikeFromThumbnail(photoId, container);
        };

        container.appendChild(likeBtn);
      }

      wrapper.appendChild(container);
    });

    updateActiveThumbnail();
  }

  // サムネイルからいいね解除
  async function removeLikeFromThumbnail(photoId, containerElement) {
    try {
      // APIでいいね解除
      const response = await fetch(`/api/like?photoId=${photoId}`, {
        method: 'DELETE'
      });

      const result = await response.json();

      if (result.success) {
        // ローカルから削除
        likedImages.delete(photoId);
        imageLikeCounts[photoId] = result.count || 0;

        // サムネイルをフェードアウトして削除
        containerElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        containerElement.style.opacity = '0';
        containerElement.style.transform = 'scale(0.8)';

        setTimeout(() => {
          containerElement.remove();

          // いいねフィルタ中のスライド配列から削除
          const photoIndex = slides.findIndex(slide => slide.dataset.photoId === photoId);
          if (photoIndex !== -1) {
            slides[photoIndex].remove(); // DOM から削除
            slides.splice(photoIndex, 1); // 配列から削除
            fileList.splice(photoIndex, 1); // ファイルリストからも削除

            // 現在のインデックスを調整
            if (idx >= slides.length) {
              idx = Math.max(0, slides.length - 1);
            }

            // 画像情報を更新
            if (slides.length > 0) {
              slides.forEach(s => s.classList.remove('active'));
              slides[idx].classList.add('active');
              updateImageInfo();
            } else {
              // いいねした写真が全て無くなった場合、全表示に戻す
              alert('いいねした写真が全て解除されました。\n全表示モードに戻ります。');
              document.getElementById('filter-all').click();
            }
          }
        }, 300);

        saveLikesToStorage();
      }
    } catch (error) {
      console.error('Failed to remove like:', error);
      alert('いいね解除に失敗しました。もう一度お試しください。');
    }
  }

  // アクティブなサムネイルを更新
  function updateActiveThumbnail(){
    document.querySelectorAll('.thumbnail').forEach((thumb, i) => {
      thumb.classList.toggle('active', i === idx);
      // いいね状態も更新（photoIdを使用）
      const photoId = thumb.dataset.photoId;
      thumb.classList.toggle('liked', likedImages.has(photoId));
    });
  }

  // サムネイル表示切り替え
  function toggleThumbnails(){
    thumbnailsVisible = !thumbnailsVisible;
    const container = document.getElementById('thumbnails-container');
    const btn = document.getElementById('thumbnails-toggle');
    const hud = document.getElementById('hud');
    const likeBtn = document.getElementById('like-btn');
    const shareBtns = document.getElementById('share-btns');

    container.classList.toggle('show', thumbnailsVisible);
    hud.classList.toggle('raised', thumbnailsVisible);
    likeBtn.classList.toggle('raised', thumbnailsVisible);
    shareBtns.classList.toggle('raised', thumbnailsVisible);

    // ボタンのテキストを切り替え
    if (thumbnailsVisible) {
      btn.textContent = '✕ 閉じる';

      // 現在のフィルター状態に応じてサムネイルを再生成
      if (currentFilter === 'liked') {
        // いいねフィルタ中は、いいねした写真だけを表示
        createThumbnails(slides);
      } else {
        // 全表示モードでは、全写真を表示
        createThumbnails(slides);
      }

      updateActiveThumbnail();
      // アクティブなサムネイルにスクロール
      const activeThumbnail = document.querySelector('.thumbnail.active');
      if (activeThumbnail) {
        activeThumbnail.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      }
    } else {
      btn.textContent = '📸 写真一覧';
    }
  }

  // 指定したスライドにジャンプ
  function jumpToSlide(targetIdx){
    if (slides.length === 0 || targetIdx < 0 || targetIdx >= slides.length) return;

    const wasRunning = running;
    if (running) pause();

    // 現在のスライドを非表示
    const curr = slides[idx];

    // 新しいスライドを表示
    idx = targetIdx;

    // クロスフェード
    curr.classList.remove('active');
    slides[idx].classList.add('active');
    updateImageInfo();
    updateActiveThumbnail();

    if (wasRunning) play();
  }

  // 画像情報を更新
  async function updateImageInfo(){
    document.getElementById('counter').textContent = `${idx + 1} / ${slides.length}`;
    document.getElementById('filename').textContent = fileList[idx]?.name || '-';

    // APIからいいね数を取得（バックグラウンドで実行）
    const currentFile = fileList[idx];
    if (currentFile && currentFile.id) {
      fetchLikeCount(currentFile.id);
    }

    updateLikeButton();
    updateActiveThumbnail();
  }

  // APIからいいね数を取得
  async function fetchLikeCount(photoId){
    try {
      const response = await fetch(`/api/like?photoId=${photoId}`);
      const result = await response.json();

      if (result.success) {
        imageLikeCounts[photoId] = result.count || 0;
        if (result.liked) {
          likedImages.add(photoId);
        } else {
          likedImages.delete(photoId);
        }
        // 現在表示中の画像なら更新
        const currentFile = fileList[idx];
        if (currentFile && currentFile.id === photoId) {
          updateLikeButton();
          updateActiveThumbnail();
        }
      }
    } catch (error) {
      console.error('Failed to fetch like count:', error);
    }
  }

  // いいねボタンの表示を更新
  function updateLikeButton(){
    const likeBtn = document.getElementById('like-btn');
    const currentFile = fileList[idx];
    if (!currentFile || !currentFile.id) return;

    const photoId = currentFile.id;
    const currentLikes = imageLikeCounts[photoId] || 0;

    console.log(`updateLikeButton: photoId=${photoId}, likes=${currentLikes}, liked=${likedImages.has(photoId)}`);

    // いいね数が0の場合はバッジを非表示
    const countBadge = currentLikes > 0 ? `<span id="like-count">${currentLikes}</span>` : '';

    if (likedImages.has(photoId)) {
      // いいね済み: 赤いハート
      likeBtn.innerHTML = `❤️${countBadge}`;
    } else {
      // 未いいね: 白いハート
      likeBtn.innerHTML = `🤍${countBadge}`;
    }
  }

  // いいね機能（Supabase連携）
  async function toggleLike(){
    const likeBtn = document.getElementById('like-btn');
    const currentFile = fileList[idx];

    if (!currentFile || !currentFile.id) {
      console.error('No file selected');
      return;
    }

    const photoId = currentFile.id;
    const isLiked = likedImages.has(photoId);

    try {
      if (isLiked) {
        // いいねを取り消す
        const response = await fetch(`/api/like?photoId=${photoId}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          likedImages.delete(photoId);
          imageLikeCounts[photoId] = result.count || 0;
        }
      } else {
        // いいねを追加
        const response = await fetch('/api/like', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ photoId })
        });

        const result = await response.json();

        if (result.success) {
          likedImages.add(photoId);
          imageLikeCounts[photoId] = result.count || 1;

          // バイブレーション（Androidのみ対応、iOSは非対応）
          try {
            if ('vibrate' in navigator) {
              navigator.vibrate([50]); // シンプルに50ms振動
            }
          } catch (e) {
            console.log('Vibration not supported');
          }
        }
      }

      updateLikeButton();
      updateActiveThumbnail();
      saveLikesToStorage(); // ローカルにもバックアップ

    } catch (error) {
      console.error('Failed to toggle like:', error);
      // エラー時はローカルのみ更新（オフライン対応）
      if (isLiked) {
        likedImages.delete(photoId);
      } else {
        likedImages.add(photoId);

        // バイブレーション（Androidのみ対応、iOSは非対応）
        try {
          if ('vibrate' in navigator) {
            navigator.vibrate([50]);
          }
        } catch (e) {
          console.log('Vibration not supported');
        }
      }
      updateLikeButton();
      saveLikesToStorage();
    }
  }

  // フィルター切り替え
  async function filterSlides(filter){
    currentFilter = filter;
    const wasRunning = running;
    if (running) pause();

    // ボタンの状態を更新
    document.getElementById('filter-all').classList.toggle('active', filter === 'all');
    document.getElementById('filter-liked').classList.toggle('active', filter === 'liked');

    if (filter === 'liked') {
      // いいねした写真だけを表示（全1146枚から検索）
      const likedPhotoIds = Array.from(likedImages);
      if (likedPhotoIds.length === 0) {
        alert('まだいいねした写真がありません。\n気に入った写真にハートボタンを押してください！');
        document.getElementById('filter-all').click();
        return;
      }

      // 全画像データからいいねした写真を抽出
      const likedPhotos = allPhotosData.filter(photo => likedImages.has(photo.id));

      if (likedPhotos.length === 0) {
        alert('いいねした写真が見つかりませんでした。');
        document.getElementById('filter-all').click();
        return;
      }

      // いいねした写真で新しいスライドを作成
      const stage = document.getElementById('stage');
      stage.innerHTML = '';
      slides = [];
      fileList = likedPhotos;

      likedPhotos.forEach((f, i) => {
        const img = document.createElement('img');
        img.src = f.url;
        img.alt = f.name || `photo-${i+1}`;
        img.className = 'slide';
        img.dataset.index = i;
        img.dataset.photoId = f.id;
        img.loading = 'lazy';
        stage.appendChild(img);
        slides.push(img);
      });

      idx = 0;
      console.log(`✅ いいねフィルタ: ${likedPhotos.length}枚の写真を表示`);
    } else {
      // 全ての写真を表示（元のランダム50枚に戻す）
      slides = [...allSlides];
      fileList = slides.map(slide => ({
        id: slide.dataset.photoId,
        name: slide.alt,
        url: slide.src
      }));
      idx = 0;
    }

    // スライドを再表示
    document.querySelectorAll('.slide').forEach(s => s.classList.remove('active'));
    if (slides[idx]) {
      slides[idx].classList.add('active');
      updateImageInfo();
    }

    // サムネイルが表示中なら再生成
    if (thumbnailsVisible) {
      createThumbnails(slides);
      updateActiveThumbnail();
    }

    if (wasRunning) play();
  }

  // いいね情報をLocalStorageに保存
  function saveLikesToStorage(){
    try {
      localStorage.setItem('tarobo-liked-images', JSON.stringify(Array.from(likedImages)));
      localStorage.setItem('tarobo-like-counts', JSON.stringify(imageLikeCounts));
    } catch(e) {
      console.log('LocalStorage保存エラー:', e);
    }
  }

  // いいね情報をLocalStorageから読み込み
  function loadLikesFromStorage(){
    try {
      const savedLiked = localStorage.getItem('tarobo-liked-images');
      const savedCounts = localStorage.getItem('tarobo-like-counts');

      if (savedLiked) {
        likedImages = new Set(JSON.parse(savedLiked));
      }
      if (savedCounts) {
        imageLikeCounts = JSON.parse(savedCounts);
      }
    } catch(e) {
      console.log('LocalStorage読み込みエラー:', e);
    }
  }

  // SNSシェア機能（現在表示中の画像をシェア）
  function shareToSNS(platform){
    if (slides.length === 0) return;

    // 現在表示中の画像情報を取得
    const currentImage = fileList[idx];
    const imageUrl = encodeURIComponent(slides[idx].src);
    const shareText = encodeURIComponent('石段を駆け抜け、未来を掴む｜太郎坊チャレンジ2025\n379段の挑戦者たち');
    const hashtags = encodeURIComponent('太郎坊チャレンジ');

    let url = '';

    switch(platform) {
      case 'twitter':
        // Twitterは画像URLとハッシュタグを含める
        url = `https://twitter.com/intent/tweet?text=${shareText}&hashtags=${hashtags}&url=${imageUrl}`;
        break;
      case 'facebook':
        // Facebookは画像URLを共有
        url = `https://www.facebook.com/sharer/sharer.php?u=${imageUrl}`;
        break;
      case 'line':
        // LINEは画像URLとテキストを共有
        url = `https://social-plugins.line.me/lineit/share?url=${imageUrl}&text=${shareText}`;
        break;
    }

    if (url) {
      window.open(url, '_blank', 'width=600,height=400');
      // シェアしたことを視覚的にフィードバック
      const btn = event.target.closest('.share-btn');
      if (btn) {
        btn.style.transform = 'scale(1.2)';
        setTimeout(() => btn.style.transform = '', 300);
      }
    }
  }

  // 画像拡大表示
  function openModal(){
    if (slides.length === 0) return;
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modal-img');
    modalImg.src = slides[idx].src;
    modal.classList.add('show');
    updateModalLikeButton();
  }

  // モーダル内のいいねボタンの表示を更新
  function updateModalLikeButton(){
    const modalLikeBtn = document.getElementById('modal-like-btn');
    const currentFile = fileList[idx];
    if (!currentFile || !currentFile.id) return;

    if (likedImages.has(currentFile.id)) {
      modalLikeBtn.textContent = '❤️';
      modalLikeBtn.classList.add('liked');
    } else {
      modalLikeBtn.textContent = '🤍';
      modalLikeBtn.classList.remove('liked');
    }
  }

  function closeModal(){
    const modal = document.getElementById('modal');
    modal.classList.remove('show');
  }

  // モーダルで次/前の画像に遷移
  function showNextInModal(){
    nextSlide();
    const modalImg = document.getElementById('modal-img');
    modalImg.src = slides[idx].src;
    updateModalLikeButton();
  }

  function showPrevInModal(){
    prevSlide();
    const modalImg = document.getElementById('modal-img');
    modalImg.src = slides[idx].src;
    updateModalLikeButton();
  }

  // エフェクトを適用
  function applyEffect(element, effect){
    // 既存のエフェクトクラスをクリア
    element.classList.remove('effect-slide-left', 'effect-slide-right', 'effect-zoom', 'effect-rotate');

    if (effect === 'random') {
      const effects = ['fade', 'slide-left', 'slide-right', 'zoom', 'rotate'];
      effect = effects[Math.floor(Math.random() * effects.length)];
    }

    if (effect !== 'fade') {
      // エフェクトクラスを追加（activeの前に）
      element.classList.add(`effect-${effect}`);
      // ブラウザに初期状態を認識させるため、強制的にリフロー
      void element.offsetWidth;
    }
  }

  // 進捗バーを更新
  function startProgressBar(){
    if (progressTimer) clearInterval(progressTimer);
    const fill = document.getElementById('progress-fill');
    let progress = 0;
    const step = 100 / (SHOW_MS / 100);

    fill.style.width = '0%';
    progressTimer = setInterval(() => {
      progress += step;
      if (progress >= 100) {
        progress = 0;
      }
      fill.style.width = `${progress}%`;
    }, 100);
  }

  function stopProgressBar(){
    if (progressTimer) {
      clearInterval(progressTimer);
      progressTimer = null;
    }
    document.getElementById('progress-fill').style.width = '0%';
  }


  function play(){
    if (running || slides.length === 0) return;
    running = true;
    if (!slides[idx].classList.contains('active')) {
      slides[idx].classList.add('active');
    }
    updateImageInfo();
    startProgressBar();

    timer = setInterval(()=>{
      const curr = slides[idx];
      idx = (idx + 1) % slides.length;
      const next = slides[idx];

      // クロスフェード: 前の画像をフェードアウト、次の画像をフェードイン
      console.log('Transition:', curr, 'to', next); // デバッグ用
      curr.classList.remove('active');
      next.classList.add('active');
      updateImageInfo();
    }, SHOW_MS);
  }

  function pause(){
    running = false;
    clearInterval(timer);
    timer = null;
    stopProgressBar();
  }

  // 次の画像へ
  function nextSlide(){
    if (slides.length === 0) return;
    const wasRunning = running;
    if (running) pause();

    const curr = slides[idx];
    idx = (idx + 1) % slides.length;
    const next = slides[idx];

    // クロスフェード
    curr.classList.remove('active');
    next.classList.add('active');
    updateImageInfo();

    if (wasRunning) play();
  }

  // 前の画像へ
  function prevSlide(){
    if (slides.length === 0) return;
    const wasRunning = running;
    if (running) pause();

    const curr = slides[idx];
    idx = (idx - 1 + slides.length) % slides.length;
    const next = slides[idx];

    // クロスフェード
    curr.classList.remove('active');
    next.classList.add('active');
    updateImageInfo();

    if (wasRunning) play();
  }

  // スピード変更
  function changeSpeed(speed){
    SHOW_MS = SPEEDS[speed];
    currentSpeed = speed;
    document.documentElement.style.setProperty('--show-ms', SHOW_MS);

    // ボタンのactive状態を更新
    document.querySelectorAll('#speed-controls button').forEach(btn => {
      btn.classList.remove('active');
    });
    document.getElementById(`btn-speed-${speed}`).classList.add('active');

    // 再生中なら再起動
    if (running) {
      pause();
      play();
    }
  }

  async function init(){
    try{
      // LocalStorageからいいね情報を読み込み
      loadLikesFromStorage();

      const {all, pick} = await fetchList();
      createSlides(pick);
      document.getElementById('info').textContent = `source=${all} / showing=${pick.length}`;
      play();
    }catch(e){
      document.getElementById('info').textContent = '読み込みに失敗しました';
      console.error(e);
    }
  }

  // BGM機能
  function initBGM(){
    bgmAudio = document.getElementById('bgm-audio');
    bgmAudio.volume = 0.5;

    document.getElementById('bgm-toggle').onclick = () => {
      const btn = document.getElementById('bgm-toggle');
      if (bgmAudio.paused) {
        bgmAudio.play().catch(e => console.log('BGM再生エラー:', e));
        btn.classList.add('playing');
        btn.textContent = '🎵 BGM停止';
      } else {
        bgmAudio.pause();
        btn.classList.remove('playing');
        btn.textContent = '🎵 BGM';
      }
    };

    document.getElementById('bgm-volume').oninput = (e) => {
      bgmAudio.volume = e.target.value / 100;
    };
  }

  // ボタンイベント
  // Play/Pause/Shuffleボタンは削除済み（画面タップで再生/一時停止）

  // スピードボタン
  // 速度コントロールは削除済み

  // いいねボタン
  document.getElementById('like-btn').onclick = toggleLike;

  // SNSシェアボタン
  document.getElementById('share-twitter').onclick = () => shareToSNS('twitter');
  document.getElementById('share-facebook').onclick = () => shareToSNS('facebook');
  document.getElementById('share-line').onclick = () => shareToSNS('line');

  // モーダル
  // モーダルのクリック・タッチイベント
  const modal = document.getElementById('modal');
  const modalImg = document.getElementById('modal-img');

  // モーダル背景クリックで閉じる
  modal.onclick = (e) => {
    if (e.target === modal) closeModal();
  };
  document.getElementById('modal-close').onclick = closeModal;

  // モーダル内のいいねボタン
  document.getElementById('modal-like-btn').onclick = async (e) => {
    e.stopPropagation(); // モーダルが閉じないようにする
    const modalLikeBtn = document.getElementById('modal-like-btn');

    // アニメーションとバイブレーションはtoggleLike内で処理されるが、
    // モーダルのボタンにもアニメーションを適用
    const currentFile = fileList[idx];
    if (!currentFile || !currentFile.id) return;

    const wasLiked = likedImages.has(currentFile.id);
    await toggleLike();

    if (!wasLiked) {
      // いいねを追加した場合のみアニメーション
      modalLikeBtn.classList.add('liked');
      setTimeout(() => modalLikeBtn.classList.remove('liked'), 600);
    }

    updateModalLikeButton();
  };

  // フリック検出用の変数
  let touchStartX = 0;
  let touchEndX = 0;
  const SWIPE_THRESHOLD = 50; // スワイプと判定する最小距離（px）

  // モーダル画像にフリック機能を追加
  modalImg.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
  }, { passive: true });

  modalImg.addEventListener('touchend', (e) => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
  }, { passive: true });

  function handleSwipe() {
    const diff = touchStartX - touchEndX;

    if (Math.abs(diff) > SWIPE_THRESHOLD) {
      if (diff > 0) {
        // 左フリック → 次の画像
        showNextInModal();
      } else {
        // 右フリック → 前の画像
        showPrevInModal();
      }
    }
  }

  // エフェクト選択
  // エフェクトセレクターは削除済み（常にフェード）

  // サムネイル表示切り替え
  document.getElementById('thumbnails-toggle').onclick = toggleThumbnails;

  // フィルターボタン
  document.getElementById('filter-all').onclick = () => filterSlides('all');
  document.getElementById('filter-liked').onclick = () => filterSlides('liked');

  // オープニング画面
  function initOpening(){
    const opening = document.getElementById('opening');

    // スタートボタン
    document.getElementById('opening-start').onclick = () => {
      opening.classList.add('hide');
      setTimeout(() => opening.style.display = 'none', 800);
    };

    // Skipボタン
    document.getElementById('opening-skip').onclick = () => {
      opening.classList.add('hide');
      setTimeout(() => opening.style.display = 'none', 800);
    };
  }

  // Aboutボタン
  let aboutVisible = false;

  document.getElementById('about-btn').onclick = () => {
    aboutVisible = !aboutVisible;
    const panel = document.getElementById('about-panel');
    panel.classList.toggle('show', aboutVisible);
  };

  // Aboutパネル外をクリックしたら閉じる
  document.addEventListener('click', (e) => {
    const aboutBtn = document.getElementById('about-btn');
    const aboutPanel = document.getElementById('about-panel');

    if (aboutVisible && !aboutBtn.contains(e.target) && !aboutPanel.contains(e.target)) {
      aboutVisible = false;
      aboutPanel.classList.remove('show');
    }
  });

  // キーボード操作
  document.addEventListener('keydown', (e) => {
    switch(e.key) {
      case ' ':           // スペースキー: 一時停止/再生
        e.preventDefault();
        if (running) pause();
        else play();
        break;
      case 'ArrowRight':  // 右矢印: 次の画像
        e.preventDefault();
        nextSlide();
        break;
      case 'ArrowLeft':   // 左矢印: 前の画像
        e.preventDefault();
        prevSlide();
        break;
      // 速度コントロールのキーボードショートカットは削除済み
      case 'l':           // Lキー: いいね
        e.preventDefault();
        toggleLike();
        break;
      case 'Enter':       // Enterキー: 画像拡大
        e.preventDefault();
        if (!document.getElementById('modal').classList.contains('show')) {
          openModal();
        } else {
          closeModal();
        }
        break;
      case 'Escape':      // Escキー: モーダルを閉じる
        e.preventDefault();
        closeModal();
        break;
      case 't':           // Tキー: サムネイル表示切り替え
        e.preventDefault();
        toggleThumbnails();
        break;
      case 'f':           // Fキー: フィルター切り替え
        e.preventDefault();
        if (currentFilter === 'all') {
          filterSlides('liked');
        } else {
          filterSlides('all');
        }
        break;
    }
  });

  // 画像クリックで拡大表示
  const stage = document.getElementById('stage');
  stage.addEventListener('click', (e) => {
    // シングルクリックで拡大表示
    if (e.detail === 1) {
      setTimeout(() => {
        if (e.detail === 1) openModal();
      }, 200);
    }
  });

  // ダブルクリック/ダブルタップでフルスクリーン
  stage.addEventListener('dblclick', ()=> {
    if (!document.fullscreenElement) stage.requestFullscreen().catch(()=>{});
    else document.exitFullscreen().catch(()=>{});
  });

  // UI自動非表示機能
  let uiHideTimer = null;
  const UI_HIDE_DELAY = 3000; // 3秒後にUIを非表示

  function hideUI() {
    document.getElementById('hud').classList.add('hidden');
    document.getElementById('image-info').classList.add('hidden');
    document.getElementById('like-btn').classList.add('hidden');
    document.getElementById('share-btns').classList.add('hidden');
    document.getElementById('about-btn').classList.add('hidden');
    document.getElementById('stats-btn').classList.add('hidden');
    document.getElementById('filter-controls').classList.add('hidden');
  }

  function showUI() {
    document.getElementById('hud').classList.remove('hidden');
    document.getElementById('image-info').classList.remove('hidden');
    document.getElementById('like-btn').classList.remove('hidden');
    document.getElementById('share-btns').classList.remove('hidden');
    document.getElementById('about-btn').classList.remove('hidden');
    document.getElementById('stats-btn').classList.remove('hidden');
    document.getElementById('filter-controls').classList.remove('hidden');

    // タイマーをリセット
    clearTimeout(uiHideTimer);
    uiHideTimer = setTimeout(hideUI, UI_HIDE_DELAY);
  }

  // ページ読み込み時と操作時にUIを表示
  function resetUITimer() {
    showUI();
  }

  // マウス移動・タップでUIを表示
  document.addEventListener('mousemove', resetUITimer);
  document.addEventListener('touchstart', resetUITimer);
  document.addEventListener('click', resetUITimer);

  // キーボード操作でもUIを表示
  document.addEventListener('keydown', resetUITimer);

  // ===== Instagram風ダブルタップでいいね機能 =====
  let lastTapTime = 0;
  const DOUBLE_TAP_DELAY = 300; // 0.3秒以内の2回タップを検出

  function setupDoubleTap() {
    const stage = document.getElementById('stage');

    stage.addEventListener('click', async (e) => {
      // モーダルが開いている場合は無効
      const modal = document.getElementById('modal');
      if (modal.classList.contains('show')) {
        return;
      }

      // UIボタンやコントロールのクリックは除外
      if (e.target.id === 'like-btn' ||
          e.target.closest('#like-btn') ||
          e.target.closest('#share-btns') ||
          e.target.closest('#filter-controls') ||
          e.target.closest('#hud')) {
        return;
      }

      const currentTime = new Date().getTime();
      const tapGap = currentTime - lastTapTime;

      if (tapGap < DOUBLE_TAP_DELAY && tapGap > 0) {
        // ダブルタップ検出
        const currentFile = fileList[idx];
        if (!currentFile || !currentFile.id) return;

        const photoId = currentFile.id;
        const isLiked = likedImages.has(photoId);

        // 既にいいね済みの場合は何もしない（Instagramと同じ）
        if (!isLiked) {
          // いいねを追加
          await toggleLike();

          // ダブルタップエフェクト（画面中央に大きなハート）
          showDoubleTapHeart(e);
        }

        lastTapTime = 0; // リセット
      } else {
        lastTapTime = currentTime;
      }
    });
  }

  // ダブルタップ時の大きなハートアニメーション（Instagram風）
  function showDoubleTapHeart(event) {
    const heart = document.createElement('div');
    heart.innerHTML = '❤️';
    heart.style.cssText = `
      position: fixed;
      font-size: 120px;
      pointer-events: none;
      z-index: 250;
      animation: doubleTapHeart 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      filter: drop-shadow(0 8px 30px rgba(0,0,0,0.5));
    `;

    // クリック位置に表示
    const x = event.clientX || window.innerWidth / 2;
    const y = event.clientY || window.innerHeight / 2;
    heart.style.left = (x - 60) + 'px';
    heart.style.top = (y - 60) + 'px';

    document.body.appendChild(heart);

    setTimeout(() => heart.remove(), 800);
  }

  // CSSアニメーションを動的に追加
  const style = document.createElement('style');
  style.textContent = `
    @keyframes doubleTapHeart {
      0% { transform: scale(0); opacity: 0; }
      15% { transform: scale(1.2); opacity: 1; }
      30% { transform: scale(1); opacity: 1; }
      70% { transform: scale(1); opacity: 1; }
      100% { transform: scale(0.8); opacity: 0; }
    }
  `;
  document.head.appendChild(style);

  // 初期表示
  resetUITimer();
  setupDoubleTap();

  // ===== 新機能: 統計情報・ランキング・リアルタイム更新 =====

  // 統計情報パネル
  let statsVisible = false;
  let statsData = null;

  document.getElementById('stats-btn').onclick = async () => {
    statsVisible = !statsVisible;
    const panel = document.getElementById('stats-panel');
    panel.classList.toggle('show', statsVisible);

    // パネルを開くたびに最新の統計情報を取得
    if (statsVisible) {
      await loadStats();
    }
  };

  // 統計情報を読み込み
  async function loadStats() {
    try {
      // サマリー取得
      const summaryRes = await fetch('/api/analytics?type=summary');
      const summaryData = await summaryRes.json();

      if (summaryData.success) {
        document.getElementById('stat-total').textContent = summaryData.data.totalLikes;
        document.getElementById('stat-photos').textContent = summaryData.data.uniquePhotos;
        document.getElementById('stat-users').textContent = summaryData.data.uniqueUsers;
        document.getElementById('stat-avg').textContent = summaryData.data.avgLikesPerPhoto.toFixed(1);
      }

      // ランキングデータは取得しない（専用ページに任せる）
      statsData = { summary: summaryData.data };

    } catch (error) {
      console.error('Failed to load stats:', error);
      document.getElementById('stat-total').textContent = 'エラー';
    }
  }

  // 統計パネル外クリックで閉じる
  document.addEventListener('click', (e) => {
    const statsBtn = document.getElementById('stats-btn');
    const statsPanel = document.getElementById('stats-panel');

    if (statsVisible && !statsBtn.contains(e.target) && !statsPanel.contains(e.target)) {
      statsVisible = false;
      statsPanel.classList.remove('show');
    }
  });

  // いいねエフェクト強化
  function createEnhancedLikeEffect(element) {
    // ハートポップアニメーション
    element.style.animation = 'heartPop 0.6s ease-out';
    setTimeout(() => {
      element.style.animation = '';
    }, 600);

    // リップルエフェクト
    // NOTE: position:fixedのボタンにはrelativeを設定しない（位置がずれるため）
    const ripple = document.createElement('div');
    ripple.className = 'ripple-effect';

    // 元のpositionを保存
    const originalPosition = window.getComputedStyle(element).position;

    // fixed以外の場合のみrelativeを設定
    if (originalPosition !== 'fixed') {
      element.style.position = 'relative';
    }

    element.appendChild(ripple);
    setTimeout(() => {
      ripple.remove();
      // positionを元に戻す（固定ボタン以外）
      if (originalPosition !== 'fixed') {
        element.style.position = '';
      }
    }, 600);

    // フローティングハート（ランダム位置）
    for (let i = 0; i < 3; i++) {
      setTimeout(() => {
        const heart = document.createElement('div');
        heart.className = 'heart-effect';
        heart.textContent = ['❤️', '💖', '💕'][i];

        const rect = element.getBoundingClientRect();
        heart.style.left = rect.left + (Math.random() * rect.width) + 'px';
        heart.style.top = rect.top + (Math.random() * rect.height) + 'px';

        document.body.appendChild(heart);
        setTimeout(() => heart.remove(), 1000);
      }, i * 100);
    }
  }

  // Instagram風いいね通知を表示
  function showLikeNotification(type) {
    const notification = document.getElementById('like-notification');
    const content = document.getElementById('like-notification-content');

    // 既存のアニメーションをリセット
    notification.classList.remove('show');
    content.classList.remove('unlike');

    if (type === 'like') {
      content.textContent = '❤️';
      content.classList.remove('unlike');
    } else if (type === 'unlike') {
      content.textContent = '🤍';
      content.classList.add('unlike');
    }

    // アニメーションを再トリガー
    setTimeout(() => {
      notification.classList.add('show');
    }, 10);

    // 0.5秒後にフェードアウト
    setTimeout(() => {
      notification.classList.remove('show');
    }, 500);
  }

  // toggleLike関数を拡張（Instagram風通知追加）
  const originalToggleLike = toggleLike;
  toggleLike = async function() {
    const currentFile = fileList[idx];
    if (!currentFile || !currentFile.id) return;

    const photoId = currentFile.id;
    const wasLiked = likedImages.has(photoId);

    // 元の関数を実行
    await originalToggleLike.call(this);

    // 現在の状態を確認
    const isNowLiked = likedImages.has(photoId);

    if (!wasLiked && isNowLiked) {
      // いいね追加時
      const likeBtn = document.getElementById('like-btn');
      createEnhancedLikeEffect(likeBtn);
      showLikeNotification('like');

      // ツールチップを「解除」に変更
      likeBtn.setAttribute('data-tooltip', '解除');
    } else if (wasLiked && !isNowLiked) {
      // いいね解除時
      showLikeNotification('unlike');

      // ツールチップを「いいね」に変更
      const likeBtn = document.getElementById('like-btn');
      likeBtn.setAttribute('data-tooltip', 'いいね');
    }
  };

  // Supabase Realtimeでリアルタイム更新
  let supabaseClient = null;
  let realtimeChannel = null;

  async function initRealtimeUpdates() {
    try {
      // Supabaseクライアントを初期化（環境変数は使えないので、公開データのみ）
      // 注: フロントエンドでは環境変数にアクセスできないため、
      // リアルタイム更新は5秒ごとのポーリングで代替

      startPollingForUpdates();
    } catch (error) {
      console.log('Realtime updates not available, using polling instead');
      startPollingForUpdates();
    }
  }

  // ポーリングでいいね数の変更を検出
  let lastKnownCounts = {};
  let pollingInterval = null;

  function startPollingForUpdates() {
    // 5秒ごとに現在の写真のいいね数をチェック
    pollingInterval = setInterval(async () => {
      if (slides.length === 0 || !fileList[idx]) return;

      const currentFile = fileList[idx];
      if (!currentFile || !currentFile.id) return;

      try {
        const response = await fetch(`/api/like?photoId=${currentFile.id}`);
        const result = await response.json();

        if (result.success) {
          const newCount = result.count || 0;
          const oldCount = lastKnownCounts[currentFile.id] || 0;

          // いいね数が増えた場合に通知
          if (oldCount > 0 && newCount > oldCount) {
            showRealtimeNotification(`誰かがこの写真にいいねしました！ (+${newCount - oldCount})`);

            // いいね数を更新
            imageLikeCounts[idx] = newCount;
            updateLikeButton();
          }

          lastKnownCounts[currentFile.id] = newCount;
        }
      } catch (error) {
        // エラーは無視（ネットワーク切断時など）
      }
    }, 5000); // 5秒ごと
  }

  // リアルタイム通知を表示
  function showRealtimeNotification(message) {
    const notify = document.getElementById('realtime-notify');
    const messageEl = document.getElementById('realtime-message');

    messageEl.textContent = message;
    notify.classList.add('show');

    setTimeout(() => {
      notify.classList.remove('show');
    }, 3000);
  }

  // UI非表示時も統計ボタンは非表示にする
  const originalHideUI = hideUI;
  hideUI = function() {
    originalHideUI();
    document.getElementById('stats-btn').classList.add('hidden');
  };

  const originalShowUI = showUI;
  showUI = function() {
    originalShowUI();
    document.getElementById('stats-btn').classList.remove('hidden');
  };

  // 初期化
  initOpening();
  initBGM();
  init();
  initRealtimeUpdates();
  </script>
</body>
</html>
